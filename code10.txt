import pandas as pd
from TM1py import TM1Service

# ==========================================
# 1. è¨­å®šå€åŸŸ
# ==========================================
TM1_CONFIG = {
    'address': 'localhost',
    'port': 12345,
    'user': 'admin',
    'password': 'password',
    'ssl': True
}

# ğŸ”¥ ä½ æƒ³æŸ¥é‚Šå€‹ç¶­åº¦ï¼Ÿ
TARGET_DIMENSION = 'Account'  

# ğŸ”¥ ä½ æƒ³æŸ¥é‚Šå€‹ Parent (e.g., account_type æˆ– Total Account)ï¼Ÿ
TARGET_PARENT = 'Net Income'  

# ==========================================
# 2. åŸ·è¡ŒæŸ¥è©¢
# ==========================================
print(f"æ­£åœ¨æŸ¥è©¢ [{TARGET_DIMENSION}] ç¶­åº¦ä¸­çš„ [{TARGET_PARENT}] ...")

try:
    with TM1Service(**TM1_CONFIG) as tm1:
        
        # --- 0. æª¢æŸ¥æ˜¯å¦å­˜åœ¨ ---
        if not tm1.elements.exists(TARGET_DIMENSION, TARGET_DIMENSION, TARGET_PARENT):
            print(f"âŒ æ‰¾ä¸åˆ°å…ƒç´ : [{TARGET_PARENT}]ã€‚è«‹æª¢æŸ¥æ‹¼å­—æˆ–å¤§å°å¯«ã€‚")
        else:
            print("âœ… å…ƒç´ å­˜åœ¨ï¼Œé–‹å§‹åˆ†ææ¶æ§‹...\n")

            # ==========================================
            # A. æŸ¥ç›´å±¬ä¸‹ä¸€å±¤ (Direct Children)
            # ==========================================
            # é€™åªæœƒé¡¯ç¤ºã€Œä¸‹ä¸€ç´šã€æ˜¯ä»€éº¼
            children = tm1.elements.get_component_names(
                dimension_name=TARGET_DIMENSION, 
                hierarchy_name=TARGET_DIMENSION, 
                element_name=TARGET_PARENT
            )
            
            print(f"--- 1. ç›´å±¬ä¸‹ä¸€å±¤ (Direct Children) å…± {len(children)} å€‹ ---")
            if children:
                df_children = pd.DataFrame(children, columns=['Child_Element'])
                print(df_children)
            else:
                print("(æ²’æœ‰ä¸‹ä¸€å±¤ï¼Œé€™æ˜¯æœ€åº•å±¤å…ƒç´ )")

            print("\n" + "="*30 + "\n")

            # ==========================================
            # B. æŸ¥æ‰€æœ‰æœ€åº•å±¤ (All Descendants / Leaves)
            # ==========================================
            # é€™æœƒã€Œä¸€ç›´æ‹†ä¸€ç›´æ‹†ã€ï¼Œç›´åˆ°æ‹†å‡ºæ‰€æœ‰ Level 0 (æœ€åº•å±¤) çš„å…ƒç´ 
            # é©åˆç”¨ä¾†æ‰¾ï¼šé€™å€‹å¤§æ•¸åŒ…å«äº†å“ªäº›æœ€ç´°çš„ Item (å¦‚ USD, CAD)
            
            mdx = f"""
            SELECT
                {{Tm1FilterByLevel(
                    {{Tm1DrillDownMember(
                        {{[{TARGET_DIMENSION}].[{TARGET_PARENT}]}}, 
                        ALL, 
                        RECURSIVE
                    )}}, 
                    0
                )}} ON ROWS,
                {{ }} ON COLUMNS
            FROM [{TARGET_DIMENSION}]
            """
            
            # ä½¿ç”¨ execute_mdx (ä¸æ˜¯ dataframe) ä¾†åªæŠ“å…ƒç´ å
            leaves = tm1.elements.execute_mdx(mdx, TARGET_DIMENSION)
            
            print(f"--- 2. æ‰€æœ‰æœ€åº•å±¤é …ç›® (All Leaves) å…± {len(leaves)} å€‹ ---")
            if leaves:
                # é€™è£¡åªåˆ—å‡ºå‰ 20 å€‹ï¼Œé¿å…æ´—ç‰ˆ
                df_leaves = pd.DataFrame(leaves, columns=['Leaf_Element'])
                print(df_leaves.head(20)) 
                if len(leaves) > 20:
                    print(f"... (é‚„æœ‰ {len(leaves)-20} å€‹æ²’é¡¯ç¤º) ...")
            else:
                print("(æœ¬èº«å°±æ˜¯æœ€åº•å±¤)")

except Exception as e:
    print(f"âŒ éŒ¯èª¤: {e}")
