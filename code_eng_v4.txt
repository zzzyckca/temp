import pandas as pd
from TM1py import TM1Service
import sys

# ==========================================
# 1. è¨­å®šå€åŸŸ (Configuration)
# ==========================================
EXCEL_FILE = 'input_params.xlsx'       # ä½ çš„è¼¸å…¥æª”
OUTPUT_FILE = 'final_result_full.csv'  # ä½ çš„è¼¸å‡ºæª”

# ğŸ”¥ Python è‡ªå‹•å¡«å…¥çš„æ™‚é–“ (Hard Code)
DERIVED_TIME_PERIOD = 'F2026.01'Â 

# TM1 é€£ç·šè³‡è¨Š (è«‹ä¿®æ”¹é€™è£¡)
TM1_CONFIG = {
    'address': 'localhost',  # ğŸ”‘ IP
    'port': 12345,           # ğŸ”‘ HTTPPort
    'user': 'admin',
    'password': 'password',
    'ssl': True
}

CUBE_NAME = "cb_reporting"  # ğŸ”‘ Cube Name

# ==========================================
# 2. ç¶­åº¦å°ç…§è¡¨ (Mapping) - å…¨ç´°æ¥·ç‰ˆ (All Lowercase)
# ==========================================
# å·¦é‚Š (Key)   : Excel Header (å¿…é ˆå…¨ç´°æ¥·)
# å³é‚Š (Value) : TM1 Dimension Name (TM1py å›å‚³é€šå¸¸ä¿‚ç´°æ¥·)

# Measure ç¨ç«‹è¨­å®š
MEASURE_MAP = {'Excel_Col': 'measure', 'TM1_Dim': 'measure'}Â 

# å…¶ä»–ç¶­åº¦ (è«‹ç¢ºä¿ Excel Header åŒé€™è£¡çš„ Key ä¸€æ¨¡ä¸€æ¨£)
ROW_DIM_MAPPING = {
    'account':                      'account',
    'operating_unit':               'operating_unit',
    'scenario':                     'scenario',
    # 'time_period':                (ä¸éœ€è¦å¯«ï¼ŒScript ä¸‹é¢æœƒè‡ªå‹•åŠ )
    'currency':                     'currency',
    'currency_display':             'currency_display',
    'project':                      'project',
    'product':                      'product',
    'channel':                      'channel',
    'segment':                      'segment',
    'gaap':                         'gaap',
    'counter_party_operating_unit': 'counter_party_operating_unit',
    'amt_type':                     'amt_type'
}

# ==========================================
# 3. Helper Functions
# ==========================================
def get_mdx_set(df, col_name, tm1_dim):
    """å°‡ DataFrame Column è½‰æˆ MDX Set å­—ä¸²"""
    # è½‰å­—ä¸²ä¸¦éæ¿¾ç©ºå€¼
    unique_items = [str(x) for x in df[col_name].unique() if pd.notna(x) and str(x).strip() != '']
   Â 
    if not unique_items:
        return None
       Â 
    # æ ¼å¼: {[Dim].[Elem1], [Dim].[Elem2]}
    item_str = ",".join([f"[{tm1_dim}].[{item}]" for item in unique_items])
    return "{" + item_str + "}"

def main():
    print("1. è®€å– Excel æª”æ¡ˆ...")
    try:
        df_master = pd.read_excel(EXCEL_FILE)
        # å¼·åˆ¶å°‡æ‰€æœ‰æ¬„ä½è½‰ç‚º String (é˜²æ­¢ Excel æ•¸å­—è¢«ç•¶æˆ float)
        df_master = df_master.astype(str)
       Â 
        # è½‰æ› Excel Header åšå…¨ç´°æ¥· (é˜²å‘†æ©Ÿåˆ¶)
        df_master.columns = df_master.columns.str.lower()
       Â 
    except Exception as e:
        print(f"âŒ è®€å– Excel å¤±æ•—: {e}")
        return

    # --- 2. æ’å…¥ Time_Period ---
    print(f"2. æ’å…¥ Time_Period: {DERIVED_TIME_PERIOD}")
    df_master['time_period'] = DERIVED_TIME_PERIOD
   Â 
    # å°‡ Time åŠ åˆ° Mapping ä¸­ (å…¨ç´°æ¥·)
    ROW_DIM_MAPPING['time_period'] = 'time_period'Â 

    # --- 3. æº–å‚™ MDX Query ---
    print("3. å‹•æ…‹çµ„è£ MDX Query...")
   Â 
    # A. è™•ç† Measure (Columns è»¸)
    measure_col = MEASURE_MAP['Excel_Col']
    measure_dim = MEASURE_MAP['TM1_Dim']
   Â 
    if measure_col not in df_master.columns:
        print(f"âŒ éŒ¯èª¤: Excel ç¼ºå°‘ Measure æ¬„ä½ [{measure_col}]")
        return

    str_measures = get_mdx_set(df_master, measure_col, measure_dim)
   Â 
    # B. è™•ç† Rows è»¸
    row_mdx_parts = []
    for excel_col, tm1_dim in ROW_DIM_MAPPING.items():
        if excel_col in df_master.columns:
            mdx_set = get_mdx_set(df_master, excel_col, tm1_dim)
            if mdx_set:
                row_mdx_parts.append(mdx_set)
        else:
            print(f"âš ï¸ è­¦å‘Š: Excel ç¼ºå°‘æ¬„ä½ [{excel_col}]ï¼Œå°‡ä½¿ç”¨ Default Memberã€‚")

    row_mdx_str = " * ".join(row_mdx_parts)

    # C. çµ„è£å®Œæ•´ MDX
    # æ³¨æ„: é€™è£¡ä½¿ç”¨äº† NON EMPTY ä¾†åŠ é€ŸæŸ¥è©¢ (ä¹‹å¾Œç”¨ Left Join è£œ 0)
    mdx_query = f"""
    SELECT
        {str_measures} ON COLUMNS,
        NON EMPTY
        ( {row_mdx_str} ) ON ROWS
    FROM [{CUBE_NAME}]
    """

    # print("DEBUG MDX:", mdx_query)Â 

    # --- 4. åŸ·è¡ŒæŸ¥è©¢ ---
    print("4. é€£æ¥ TM1 ä¸¦åŸ·è¡ŒæŸ¥è©¢...")
    df_tm1 = pd.DataFrame()
   Â 
    try:
        with TM1Service(**TM1_CONFIG) as tm1:
            # åŸ·è¡Œ MDX
            df_tm1 = tm1.cells.execute_mdx_dataframe(mdx_query)
           Â 
            # Reset Index (å°‡ Row Dimensions è®Šæˆæ™®é€š Columns)
            df_tm1 = df_tm1.reset_index()
           Â 
            # å°‡ TM1 å›å‚³çš„ Columns å…¨éƒ¨è½‰ç´°æ¥· (ç¢ºä¿ Merge Key ä¸€è‡´)
            df_tm1.columns = df_tm1.columns.str.lower()
           Â 
            print(f"âœ… TM1 å›å‚³äº† {len(df_tm1)} ç­†æ•¸æ“šã€‚")
           Â 
    except Exception as e:
        print(f"âŒ TM1 é€£ç·šæˆ–æŸ¥è©¢éŒ¯èª¤: {e}")
        return

    # --- 5. æ•¸æ“šè™•ç† & Merge ---
    if not df_tm1.empty:
        print("5. æ­£åœ¨æ•´ç†æ•¸æ“š (Unpivot & Left Join)...")

        # A. Unpivot (Melt) - å°‡å¯¬è¡¨è®Šé•·è¡¨
        # æ‰¾å‡ºå“ªäº›æ˜¯ç¶­åº¦ (ID Vars) -> å³ä¿‚å””ä¿‚ Measure æ—¢æ¬„ä½
        excel_measure_values = [x.lower() for x in df_master[measure_col].unique()]
        id_vars = [col for col in df_tm1.columns if col not in excel_measure_values]
       Â 
        # ğŸ”¥ é‡é»: value_name='tm1_value' é¿å…åŒåŸæœ¬å¯èƒ½æœ‰æ—¢ 'Value' æ’å
        df_tm1_long = df_tm1.melt(
            id_vars=id_vars,Â 
            var_name=measure_dim,Â 
            value_name='tm1_value'Â 
        )
       Â 
        # ç¢ºä¿æ‰€æœ‰ç”¨æ–¼ Merge çš„æ¬„ä½éƒ½æ˜¯ String
        for col in df_tm1_long.columns:
             df_tm1_long[col] = df_tm1_long[col].astype(str)

        # B. æº–å‚™ Merge Keys
        left_keys = list(ROW_DIM_MAPPING.keys()) + [measure_col]
        right_keys = list(ROW_DIM_MAPPING.values()) + [measure_dim]

        # å†æ¬¡æª¢æŸ¥ Keys æ˜¯å¦éƒ½åœ¨ DataFrame è£¡ (Debug ç”¨)
        # print(f"Left Keys: {left_keys}")
        # print(f"Right Keys: {right_keys}")

        # C. åŸ·è¡Œ Left Join
        final_df = pd.merge(
            df_master,
            df_tm1_long,
            how='left',
            left_on=left_keys,
            right_on=right_keys
        )

        # D. å¡«è£œ 0 (Fill NA)
        final_df['tm1_value'] = final_df['tm1_value'].fillna(0)
       Â 
        # E. è¼¸å‡º
        final_df.to_csv(OUTPUT_FILE, index=False)
        print(f"ğŸ‰ å®Œæˆï¼çµæœå·²å„²å­˜è‡³ {OUTPUT_FILE}")

    else:
        print("âš ï¸ TM1 å›å‚³ç©ºæ•¸æ“š (æˆ–å…¨éƒ¨è¢«æ¿¾èµ°)ã€‚æ‰€æœ‰è¡Œå¡« 0ã€‚")
        df_master['tm1_value'] = 0
        df_master.to_csv(OUTPUT_FILE, index=False)

if __name__ == "__main__":
    main()
