import pandas as pd
from TM1py import TM1Service

# --- é€£ç·šè¨­å®š ---
TM1_CONFIG = {
    'address': 'localhost',  # ğŸ”‘ å¡«å› IP
    'port': 12345,           # ğŸ”‘ å¡«å› HTTPPort
    'user': 'admin',
    'password': 'password',
    'ssl': True
}

def main():
    CUBE_NAME = "cb_reporting"Â 

    print(f"æ­£åœ¨é€£ç·šä¸¦æŸ¥è©¢ Cube: [{CUBE_NAME}] ...")

    # --- åƒæ•¸è¨­å®š ---
    context_map = {
        'Account':                       'BS174',Â 
        'Operating_Unit':                '83146',Â 
        'Scenario':                      'Adjusted Actual',Â 
        'Measure':                       'Mx_2',Â 
        'Time_Period':                   'F2026.01',  # âœ… ä½¿ç”¨æ­£ç¢ºçš„ F2026.01
       Â 
        # --- å…¶ä»– Context (è«‹ç¢ºä¿æ²’æœ‰æ¼æ‰ç¶­åº¦ï¼) ---
        'Amt_Type':                      'Display',
        'Currency':                      'All Currencies',
        'Currency_Display':              'CAD',
        'Project':                       'Total Leafs',
        'Product':                       'Total Leafs',
        'Channel':                       'Total Leafs',
        'Segment':                       'Total Leafs',
        'GAAP':                          'CBTOTAL',
        'Counter_Party_Operating_Unit':  'Total Leafs',
    }

    try:
        # åˆ†é›¢ Measure
        if 'Measure' in context_map:
            measure_elem = context_map.pop('Measure')
        else:
            measure_elem = 'Mx_2'

        # çµ„åˆ Rows
        row_mdx_parts = []
        for dim, elem in context_map.items():
            row_mdx_parts.append(f"[{dim}].[{elem}]")
       Â 
        row_mdx_str = " * ".join([f"{{{p}}}" for p in row_mdx_parts])
       Â 
        # ğŸ”¥ é€™è£¡ **æ²’æœ‰** NON EMPTY
        mdx_query = f"""
        SELECT
            {{[Measure].[{measure_elem}]}} ON COLUMNS,
            ( {row_mdx_str} ) ON ROWS
        FROM [{CUBE_NAME}]
        """

        print("\n--- Generated MDX (é©—è­‰ç”¨) ---")
        print(mdx_query)
        print("------------------------------\n")

        with TM1Service(**TM1_CONFIG) as tm1:
            print("æ­£åœ¨åŸ·è¡Œ Query (å¼·åˆ¶è®€å– 0)...")
            df = tm1.cells.execute_mdx_dataframe(mdx_query)
           Â 
            # ğŸ”¥ é—œéµï¼šå°‡ NaN (ç©ºå€¼) å¡«è£œç‚º 0
            df.fillna(0, inplace=True)

            if not df.empty:
                print("\nâœ… æˆåŠŸï¼æ•¸æ“šå¦‚ä¸‹ (åŒ…å« 0)ï¼š")
                print(df)
            else:
                print("\nâŒ ä»ç„¶æ˜¯ç©º DataFrameã€‚")
                print("é€™ä»£è¡¨æŸ¥è©¢çš„ç¶­åº¦çµ„åˆåœ¨ Cube ä¸­æ ¹æœ¬ç„¡æ³•å½¢æˆæœ‰æ•ˆçš„äº¤é›† (Tuple)ã€‚")
                print("è«‹å›é ­åŸ·è¡Œ 'ç¬¬ä¸€æ­¥'ï¼Œæª¢æŸ¥æ˜¯å¦æ¼äº†ç¶­åº¦ã€‚")

    except Exception as e:
        print(f"\nâŒ éŒ¯èª¤: {e}")

if __name__ == "__main__":
    main()
