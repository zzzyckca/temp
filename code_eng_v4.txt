# ==========================================
# BLOCK 1: Setup & Configuration
# Highlight this block and RUN first
# ==========================================
import win32com.client
import os
import shutil
import pandas as pd

# --- USER CONFIG ---
# Update this with the account name you found in Checkpoint 1
TARGET_ACCOUNT_NAME = "data.team@rbc.com" 

# File Paths
CONFIG_FILE_PATH = r"C:\Work\config.xlsx"   # Excel Config Path
TEMP_FOLDER = r"C:\Work\Temp"               # Temp download path
DEFAULT_FOLDER = r"C:\Work\Unsorted"        # Default destination
TARGET_SUBJECT = "TRIGGER_ME"               # Keyword to look for in Subject

# Create folders if they don't exist
for f in [TEMP_FOLDER, DEFAULT_FOLDER]:
    os.makedirs(f, exist_ok=True)

print("‚úÖ Block 1: Config loaded.")


# ==========================================
# BLOCK 2: Connect to Specific Inbox
# Highlight this block and RUN
# ==========================================
outlook = win32com.client.Dispatch("Outlook.Application").GetNamespace("MAPI")

target_inbox = None

# Loop to find the account
for folder in outlook.Folders:
    if folder.Name.lower() == TARGET_ACCOUNT_NAME.lower():
        # Try to find Inbox (or 'Êî∂‰ª∂ÁÆ±' if Chinese)
        try:
            target_inbox = folder.Folders("Inbox")
            print(f"‚úÖ Block 2: Successfully connected to Inbox of '{folder.Name}'")
        except:
            print(f"‚ùå Found account '{folder.Name}' but could not find 'Inbox' folder.")
        break

if not target_inbox:
    print(f"‚ùå Block 2 Failed: Could not find account '{TARGET_ACCOUNT_NAME}'. Check your spelling.")


# ==========================================
# BLOCK 3: Load Excel Rules
# Highlight this block and RUN
# ==========================================
excel_rules = []
try:
    df = pd.read_excel(CONFIG_FILE_PATH)
    excel_rules = df.to_dict('records')
    print(f"‚úÖ Block 3: Loaded {len(excel_rules)} rules from Excel.")
    print(df.head()) # Show first few rows to verify
except Exception as e:
    print(f"‚ùå Block 3 Failed: Error reading Excel. {e}")


# ==========================================
# BLOCK 4: The Main Loop (Process Emails)
# Highlight this block and RUN
# ==========================================
if target_inbox and excel_rules:
    print("\nüöÄ Starting to scan emails...")
    
    # Get ALL items in Inbox (We will filter manually in Python loop)
    # Sort by ReceivedTime Descending (Newest first)
    messages = target_inbox.Items
    messages.Sort("[ReceivedTime]", True)

    processed_count = 0
    
    # Loop through the first 10 emails just for testing (to avoid waiting too long)
    # Note: Outlook index starts at 1
    scan_limit = min(10, messages.Count)
    
    for i in range(1, scan_limit + 1):
        msg = messages.Item(i)
        
        # --- DEBUG LOGGING ---
        # Let's see what the script sees
        print(f"Checking Email [{i}]: '{msg.Subject}' (UnRead: {msg.UnRead})")

        # 1. Check Unread Status
        if not msg.UnRead:
            print(f"   -> Skipping: Email is already read.")
            continue
            
        # 2. Check Subject (Case-insensitive match)
        # Using "in" allows partial match (e.g. "FW: TRIGGER_ME - Daily")
        if TARGET_SUBJECT.lower() not in msg.Subject.lower():
            print(f"   -> Skipping: Subject does not contain '{TARGET_SUBJECT}'")
            continue

        # 3. Check Attachments
        if msg.Attachments.Count == 0:
            print(f"   -> Skipping: No attachments.")
            continue
            
        # === IF WE GET HERE, IT'S A MATCH ===
        print(f"   üéØ MATCH FOUND! Processing attachments...")
        
        for j in range(1, msg.Attachments.Count + 1):
            attachment = msg.Attachments.Item(j)
            filename = attachment.FileName
            print(f"      üìé Found file: {filename}")
            
            # Save to Temp
            temp_path = os.path.join(TEMP_FOLDER, filename)
            try:
                attachment.SaveAsFile(temp_path)
            except Exception as save_err:
                print(f"      ‚ùå Save Error: {save_err}")
                continue

            # Check against Excel Rules
            destination = DEFAULT_FOLDER
            matched_rule_name = "Default"
            
            for rule in excel_rules:
                rule_keyword = str(rule.get('Keyword', '')).lower()
                if rule_keyword and rule_keyword in filename.lower():
                    destination = rule.get('Destination_Folder')
                    matched_rule_name = rule_keyword
                    break # Stop checking rules
            
            # Move File
            try:
                os.makedirs(destination, exist_ok=True)
                final_path = os.path.join(destination, filename)
                shutil.move(temp_path, final_path)
                print(f"      üöö Moved to: {final_path} (Rule: {matched_rule_name})")
            except Exception as move_err:
                print(f"      ‚ùå Move Error: {move_err}")

        # 4. Mark as Read (Done)
        msg.UnRead = False
        processed_count += 1
        print("      ‚úÖ Email marked as Read.")

    print(f"\n‚ú® Block 4 Finished. Processed {processed_count} emails.")
else:
    print("‚ùå Cannot run Block 4: Inbox or Rules not loaded.")