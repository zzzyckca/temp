import pandas as pd
from TM1py import TM1Service

# ==========================================
# 1. è¨­å®šå€åŸŸ (Configuration)
# ==========================================
EXCEL_FILE = 'input_params.xlsx'
OUTPUT_FILE = 'final_result_dynamic.csv'

# ğŸ”¥ Python è‡ªå‹•å¡«å…¥çš„æ™‚é–“
DERIVED_TIME_PERIOD = 'F2026.01'Â 

TM1_CONFIG = {
    'address': 'localhost', Â 
    'port': 12345,          Â 
    'user': 'admin',
    'password': 'password',
    'ssl': True
}

CUBE_NAME = "cb_reporting"Â 

# ==========================================
# 2. ç¶­åº¦å°ç…§è¡¨ (Mapping)
# ==========================================
# å·¦é‚Š(Key): Excel Column Name
# å³é‚Š(Value): TM1 Dimension Name

# âš ï¸ ç‰¹åˆ¥å°‡ Measure ç¨ç«‹å‡ºä¾†è¨­å®šï¼Œå› ç‚ºå®ƒè¦æ”¾åœ¨ Column è»¸
MEASURE_MAP = {'Excel_Col': 'Measure', 'TM1_Dim': 'Measure'}Â 

# å…¶ä»–æ”¾åœ¨ Row è»¸çš„ç¶­åº¦
ROW_DIM_MAPPING = {
    'Account':                      'Account',
    'Operating_Unit':               'Operating_Unit',
    'Scenario':                     'Scenario',
    # 'Time_Period':  <-- ä¸éœ€è¦ï¼ŒScript æœƒè‡ªå‹•åŠ 
    'Currency':                     'Currency',
    'Currency_Display':             'Currency_Display',
    'Project':                      'Project',
    'Product':                      'Product',
    'Channel':                      'Channel',
    'Segment':                      'Segment',
    'GAAP':                         'GAAP',
    'Counter_Party_Operating_Unit': 'Counter_Party_Operating_Unit',
    'Amt_Type':                     'Amt_Type'
}

def get_mdx_set(df, col_name, tm1_dim):
    """å°‡ DataFrame Column è½‰æˆ MDX Set å­—ä¸²"""
    unique_items = [str(x) for x in df[col_name].unique() if pd.notna(x)]
    if not unique_items:
        return None
    # æ ¼å¼: {[Dim].[Elem1], [Dim].[Elem2]}
    item_str = ",".join([f"[{tm1_dim}].[{item}]" for item in unique_items])
    return "{" + item_str + "}"

def main():
    print("1. è®€å– Excel æª”æ¡ˆ...")
    try:
        df_master = pd.read_excel(EXCEL_FILE)
        df_master = df_master.astype(str) # å¼·åˆ¶è½‰å­—ä¸²
    except Exception as e:
        print(f"âŒ è®€å– Excel å¤±æ•—: {e}")
        return

    # --- 2. æ’å…¥ Time_Period ---
    print(f"2. æ’å…¥ Time_Period: {DERIVED_TIME_PERIOD}")
    df_master['Time_Period'] = DERIVED_TIME_PERIOD
   Â 
    # å°‡ Time åŠ åˆ° Row Mapping ä¸­
    ROW_DIM_MAPPING['Time_Period'] = 'Time_Period'Â 

    # --- 3. æº–å‚™ MDX Query ---
    print("3. å‹•æ…‹çµ„è£ MDX Query...")
   Â 
    # A. è™•ç† Columns è»¸ (Dynamic Measures)
    measure_col = MEASURE_MAP['Excel_Col']
    measure_dim = MEASURE_MAP['TM1_Dim']
   Â 
    if measure_col not in df_master.columns:
        print(f"âŒ Excel ç¼ºå°‘ Measure æ¬„ä½ [{measure_col}]")
        return

    # å–å¾—æ‰€æœ‰å‡ºç¾éçš„ Measure
    str_measures = get_mdx_set(df_master, measure_col, measure_dim)
   Â 
    # B. è™•ç† Rows è»¸ (å…¶ä»–ç¶­åº¦)
    row_mdx_parts = []
    for excel_col, tm1_dim in ROW_DIM_MAPPING.items():
        if excel_col in df_master.columns:
            mdx_set = get_mdx_set(df_master, excel_col, tm1_dim)
            if mdx_set:
                row_mdx_parts.append(mdx_set)
        else:
            print(f"âš ï¸ è­¦å‘Š: Excel ç¼ºå°‘æ¬„ä½ [{excel_col}]")

    row_mdx_str = " * ".join(row_mdx_parts)

    # C. çµ„è£ MDX (Columns æ”¾ Measure, Rows æ”¾å…¶ä»–)
    mdx_query = f"""
    SELECT
        {str_measures} ON COLUMNS,
        NON EMPTY
        ( {row_mdx_str} ) ON ROWS
    FROM [{CUBE_NAME}]
    """

    # print(mdx_query) # Debug ç”¨

    # --- 4. åŸ·è¡ŒæŸ¥è©¢ ---
    print("4. é€£æ¥ TM1 ä¸¦åŸ·è¡ŒæŸ¥è©¢...")
    try:
        with TM1Service(**TM1_CONFIG) as tm1:
            df_tm1 = tm1.cells.execute_mdx_dataframe(mdx_query)
            # Reset Index (å°‡ Row ç¶­åº¦è®Šæˆæ™®é€š Columns)
            df_tm1 = df_tm1.reset_index()
            print(f"âœ… TM1 å›å‚³äº† {len(df_tm1)} ç­†æ•¸æ“š (Pivot æ ¼å¼)ã€‚")
           Â 
    except Exception as e:
        print(f"âŒ TM1 é€£ç·šéŒ¯èª¤: {e}")
        return

    # --- 5. è™•ç†æ•¸æ“š (Unpivot & Join) ---
    if not df_tm1.empty:
        print("5. æ­£åœ¨æ•´ç†æ•¸æ“šä¸¦ Merge å› Excel...")

        # A. Unpivot (Melt): æŠŠå¯¬è¡¨è®Šé•·è¡¨
        # TM1py å›å‚³çš„ Columns æœƒåŒ…å« Row Dimensions + æ¯å€‹ Measure çš„åå­—
        # æˆ‘å€‘è¦æŠŠ Measure Columns (ä¾‹å¦‚ 'Mx_2', 'Amount') è®Šæˆä¸€å€‹æ¬„ä½
       Â 
        # æ‰¾å‡ºå“ªäº›æ¬„ä½æ˜¯ç¶­åº¦ (ID Vars)
        # é€šå¸¸æ˜¯ ROW_DIM_MAPPING çš„ Values (TM1 Dim Names)
        id_vars = [col for col in df_tm1.columns if col not in df_master[measure_col].unique()]
       Â 
        # åŸ·è¡Œ Melt
        df_tm1_long = df_tm1.melt(
            id_vars=id_vars,Â 
            var_name=measure_dim, # é€™è£¡æœƒè®Šæˆ TM1 çš„ Dimension Name (e.g. 'Measure')
            value_name='Value'
        )
       Â 
        # ç¢ºä¿ Merge Key æ ¼å¼ä¸€è‡´
        for col in df_tm1_long.columns:
             df_tm1_long[col] = df_tm1_long[col].astype(str)

        # B. Left Join
        # æº–å‚™ Keys: Excel Col vs TM1 Col
        # æ³¨æ„ï¼šç¾åœ¨æˆ‘å€‘ä¹Ÿè¦ Join 'Measure' äº†
        left_keys = list(ROW_DIM_MAPPING.keys()) + [measure_col]
        right_keys = list(ROW_DIM_MAPPING.values()) + [measure_dim]

        final_df = pd.merge(
            df_master,
            df_tm1_long,
            how='left',
            left_on=left_keys,
            right_on=right_keys
        )

        # C. å¡«è£œ 0
        final_df['Value'] = final_df['Value'].fillna(0)
       Â 
        final_df.to_csv(OUTPUT_FILE, index=False)
        print(f"ğŸ‰ å®Œæˆï¼çµæœå·²å„²å­˜è‡³ {OUTPUT_FILE}")

    else:
        print("âš ï¸ TM1 å›å‚³ç©ºæ•¸æ“šï¼Œå…¨éƒ¨å¡« 0ã€‚")
        df_master['Value'] = 0
        df_master.to_csv(OUTPUT_FILE, index=False)

if __name__ == "__main__":
    main()
