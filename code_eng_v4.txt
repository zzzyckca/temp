import pandas as pd
from TM1py import TM1Service

# ==========================================
# 1. è¨­å®šå€åŸŸ (Configuration)
# ==========================================
EXCEL_FILE = 'input_params.xlsx'  # ä½ çš„ Excel æª”å
OUTPUT_FILE = 'final_result_with_values.csv'

# ğŸ”¥ é€™è£¡è¨­å®šä½ åœ¨ Python è£¡è¦ "Hard Code" çš„æ™‚é–“
DERIVED_TIME_PERIOD = 'F2026.01'Â 

TM1_CONFIG = {
    'address': 'localhost',  # è¨˜å¾—æ”¹ IP
    'port': 12345,           # è¨˜å¾—æ”¹ Port
    'user': 'admin',
    'password': 'password',
    'ssl': True
}

# ä½ çš„ Cube åç¨±
CUBE_NAME = "cb_reporting"Â 

# Measure ç¶­åº¦çš„è¨­å®š (æ”¾åœ¨ Columns è»¸)
MEASURE_DIM = 'Measure'
MEASURE_ELEM = 'Mx_2'

# ==========================================
# 2. ç¶­åº¦å°ç…§è¡¨ (Mapping)
# ==========================================
# å·¦é‚Š (Key): Excel è£¡é¢çš„ Column Header
# å³é‚Š (Value): TM1 Server è£¡é¢çš„ Dimension Name
# âš ï¸ è«‹ç¢ºä¿å³é‚Šçš„åå­—è·Ÿ TM1 Server ä¸€æ¨¡ä¸€æ¨£
DIM_MAPPING = {
    'Account':                      'Account',
    'Operating_Unit':               'Operating_Unit',
    'Scenario':                     'Scenario',
    # 'Time_Period':  <-- ä¸éœ€è¦å¯«åœ¨é€™è£¡ï¼Œæˆ‘å€‘æœƒè‡ªå‹•åŠ 
    'Currency':                     'Currency',
    'Currency_Display':             'Currency_Display',
    'Project':                      'Project',
    'Product':                      'Product',
    'Channel':                      'Channel',
    'Segment':                      'Segment',
    'GAAP':                         'GAAP',
    'Counter_Party_Operating_Unit': 'Counter_Party_Operating_Unit',
    'Amt_Type':                     'Amt_Type'
}

def get_mdx_set(df, col_name, tm1_dim):
    """å°‡ DataFrame Column è½‰æˆ MDX Set å­—ä¸²"""
    unique_items = [str(x) for x in df[col_name].unique() if pd.notna(x)]
    if not unique_items:
        return None
    # æ ¼å¼: {[Dim].[Elem1], [Dim].[Elem2]}
    item_str = ",".join([f"[{tm1_dim}].[{item}]" for item in unique_items])
    return "{" + item_str + "}"

def main():
    print("1. è®€å– Excel æª”æ¡ˆ...")
    try:
        df_master = pd.read_excel(EXCEL_FILE)
        # å¼·åˆ¶è½‰æˆå­—ä¸²ï¼Œé¿å…æ•¸å­—æ ¼å¼å•é¡Œ
        df_master = df_master.astype(str)
    except Exception as e:
        print(f"âŒ è®€å– Excel å¤±æ•—: {e}")
        return

    # --- é—œéµæ­¥é©Ÿï¼šåœ¨ Python è£¡ "Derive" Time Period ---
    print(f"2. æ’å…¥ Time_Period: {DERIVED_TIME_PERIOD}")
    df_master['Time_Period'] = DERIVED_TIME_PERIOD
   Â 
    # æŠŠå®ƒåŠ é€² Mapping æ–¹ä¾¿ç­‰ä¸€ä¸‹åš Merge
    # å‡è¨­ TM1 ç¶­åº¦åå«åš 'Time_Period' (å¦‚æœä¸ä¸€æ¨£è«‹ä¿®æ”¹é€™è£¡)
    DIM_MAPPING['Time_Period'] = 'Time_Period'Â 

    print("3. æº–å‚™ MDX Query (Bulk Query)...")
   Â 
    # å‹•æ…‹çµ„è£ Rows çš„ Set
    row_mdx_parts = []
   Â 
    for excel_col, tm1_dim in DIM_MAPPING.items():
        if excel_col in df_master.columns:
            mdx_set = get_mdx_set(df_master, excel_col, tm1_dim)
            if mdx_set:
                row_mdx_parts.append(mdx_set)
        else:
            print(f"âš ï¸ è­¦å‘Š: Excel ç¼ºå°‘æ¬„ä½ [{excel_col}]ï¼Œå°‡ä½¿ç”¨ Default Memberã€‚")

    # CrossJoin æ‰€æœ‰ç¶­åº¦
    row_mdx_str = " * ".join(row_mdx_parts)

    # çµ„è£å®Œæ•´ MDX
    # é€™è£¡æˆ‘å€‘ä½¿ç”¨ NON EMPTY è®“æŸ¥è©¢å¿«ä¸€é»ï¼Œåæ­£å¾Œé¢ Left Join æœƒè£œ 0
    mdx_query = f"""
    SELECT
        {{[{MEASURE_DIM}].[{MEASURE_ELEM}]}} ON COLUMNS,
        NON EMPTY
        ( {row_mdx_str} ) ON ROWS
    FROM [{CUBE_NAME}]
    """

    print("4. é€£æ¥ TM1 ä¸¦åŸ·è¡ŒæŸ¥è©¢...")
    try:
        with TM1Service(**TM1_CONFIG) as tm1:
            # åŸ·è¡ŒæŸ¥è©¢
            df_tm1 = tm1.cells.execute_mdx_dataframe(mdx_query)
           Â 
            # Reset Index æŠŠ Dimensions è®Šæˆæ™®é€š Columns
            df_tm1 = df_tm1.reset_index()
           Â 
            print(f"âœ… TM1 å›å‚³äº† {len(df_tm1)} ç­†æ•¸æ“šã€‚")

    except Exception as e:
        print(f"âŒ TM1 é€£ç·šéŒ¯èª¤: {e}")
        return

    # ==========================================
    # 5. LEFT JOIN (æ ¸å¿ƒé‚è¼¯)
    # ==========================================
    print("5. æ­£åœ¨å°‡æ•¸æ“š 'æ‹' å› Excel è¡¨ (Left Join)...")

    if not df_tm1.empty:
        # æº–å‚™ Merge çš„ Key
        # å·¦é‚Šæ˜¯ Excel çš„ Column Nameï¼Œå³é‚Šæ˜¯ TM1py å›å‚³çš„ Dimension Name
        # å¦‚æœä½  Mapping çš„å·¦å³åå­—ä¸€æ¨£ï¼Œé€™ä¸€æ­¥å¾ˆç°¡å–®
        left_on_keys = list(DIM_MAPPING.keys())
        right_on_keys = list(DIM_MAPPING.values())

        # ç¢ºä¿ TM1 æ•¸æ“šä¹Ÿæ˜¯ String æ ¼å¼ï¼Œé¿å… Key Mismatch
        for col in right_on_keys:
            if col in df_tm1.columns:
                df_tm1[col] = df_tm1[col].astype(str)

        # åŸ·è¡Œ Merge
        final_df = pd.merge(
            df_master,Â 
            df_tm1,Â 
            how='left',      # ä»¥ Excel ç‚ºä¸»
            left_on=left_on_keys,
            right_on=right_on_keys
        )

        # è™•ç†æ•¸å€¼æ¬„ä½ (æŠŠ NaN è®Šæˆ 0)
        # TM1py å›å‚³çš„æ•¸å€¼æ¬„ä½é€šå¸¸å« 'Value' æˆ–è€… Measure çš„åå­— (Mx_2)
        # æˆ‘å€‘æª¢æŸ¥ä¸€ä¸‹
        possible_val_cols = ['Value', 'Mx_2', MEASURE_ELEM]
        target_val_col = None
        for col in possible_val_cols:
            if col in final_df.columns:
                target_val_col = col
                break
       Â 
        if target_val_col:
            print(f"   -> æ•¸å€¼æ¬„ä½æ˜¯ [{target_val_col}]ï¼Œæ­£åœ¨è£œ 0...")
            final_df[target_val_col] = final_df[target_val_col].fillna(0)
       Â 
        # è¼¸å‡ºçµæœ
        final_df.to_csv(OUTPUT_FILE, index=False)
        print(f"ğŸ‰ å®Œæˆï¼çµæœå·²å„²å­˜è‡³ {OUTPUT_FILE}")

    else:
        print("âš ï¸ TM1 å›å‚³ç©ºæ•¸æ“šã€‚æ‰€æœ‰ Excel è¡Œå°‡å¡«è£œç‚º 0ã€‚")
        df_master['Value'] = 0
        df_master.to_csv(OUTPUT_FILE, index=False)

if __name__ == "__main__":
    main()
