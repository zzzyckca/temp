import pandas as pd
from TM1py import TM1Service

# ==========================================
# 1. è¨­å®šå€åŸŸ
# ==========================================
EXCEL_FILE = 'input_params.xlsx'      Â 
OUTPUT_FILE = 'final_result_direct.csv'
DERIVED_TIME_PERIOD = 'F2026.01'Â 

TM1_CONFIG = {
    'address': 'localhost',
    'port': 12345,
    'user': 'admin',
    'password': 'password',
    'ssl': True
}
CUBE_NAME = "cb_reporting"Â 

# ==========================================
# 2. æº–å‚™ Master Table (Excel + Time)
# ==========================================
print("--- 1. è®€å– Excel ä¸¦æ•´ç† ---")
# è®€å– Excel
df_master = pd.read_excel(EXCEL_FILE)
df_master = df_master.astype(str)

# è½‰ç´°æ¥· + å»é™¤ç©ºæ ¼ (ç¢ºä¿ Join Key ä¸€è‡´)
df_master.columns = df_master.columns.str.lower().str.strip()

# æ’å…¥ Time Period
df_master['time_period'] = DERIVED_TIME_PERIOD

print(f"Excel Columns (Join Keys): {df_master.columns.tolist()}")

# ==========================================
# 3. å®šç¾© Mapping (Excel Columns vs TM1 Dimensions)
# ==========================================
# âš ï¸ æ³¨æ„ï¼šé€™è£¡åŒ…å«äº† Measure åŒ Time_Periodï¼Œå…¨éƒ¨ç•¶ä½œä¸€èˆ¬ç¶­åº¦è™•ç†
# å·¦é‚Š: Excel Header (å·²è½‰ç´°æ¥·)
# å³é‚Š: TM1 Dimension Name
ROW_DIM_MAPPING = {
    'account':                      'account',
    'operating_unit':               'operating_unit',
    'scenario':                     'scenario',
    'time_period':                  'time_period',  # Python åŠ æœå€‹
    'currency':                     'currency',
    'currency_display':             'currency_display',
    'project':                      'project',
    'product':                      'product',
    'channel':                      'channel',
    'segment':                      'segment',
    'gaap':                         'gaap',
    'counter_party_operating_unit': 'counter_party_operating_unit',
    'amt_type':                     'amt_type',
    'measure':                      'measure'       # ğŸ”¥ Measure éƒ½æ”¾ä¿‚åº¦
}

# ==========================================
# 4. çµ„è£ MDX (ç„¡ NON EMPTY)
# ==========================================
print("--- 2. çµ„è£ MDX ---")

row_mdx_parts = []
for excel_col, tm1_dim in ROW_DIM_MAPPING.items():
    if excel_col in df_master.columns:
        unique_items = [x for x in df_master[excel_col].unique() if x and x.lower() != 'nan']
        if unique_items:
            # å»ºç«‹ Set: {[Dim].[Item1], [Dim].[Item2]}
            mdx_set = "{" + ",".join([f"[{tm1_dim}].[{item}]" for item in unique_items]) + "}"
            row_mdx_parts.append(mdx_set)

# CrossJoin æ‰€æœ‰ç¶­åº¦
row_mdx_str = " * ".join(row_mdx_parts)

# ğŸ”¥ é‡é»ï¼šç§»é™¤ NON EMPTYï¼Œç¢ºä¿ 0 éƒ½æœƒå›å‚³
# æˆ‘å€‘å°‡æ‰€æœ‰ç¶­åº¦ (åŒ…æ‹¬ Measure) æ”¾ Rowsï¼ŒColumns æ”¾ç©º {}Â 
mdx_query = f"""
SELECT
    {{ }} ON 0,
    ( {row_mdx_str} ) ON 1
FROM [{CUBE_NAME}]
"""

# ==========================================
# 5. åŸ·è¡ŒæŸ¥è©¢ & æ•´ç† TM1 æ•¸æ“š
# ==========================================
print("--- 3. é€£ç·š TM1 ---")
df_tm1 = pd.DataFrame()

with TM1Service(**TM1_CONFIG) as tm1:
    # åŸ·è¡Œ Query
    df_tm1 = tm1.cells.execute_mdx_dataframe(mdx_query)
   Â 
    # Reset Index (å°‡ Dimensions è®Šæˆ Columns)
    df_tm1 = df_tm1.reset_index()
   Â 
    # è½‰ç´°æ¥· (ç¢ºä¿åŒ Master Table å°æ‡‰)
    df_tm1.columns = df_tm1.columns.str.lower().str.strip()

# ==========================================
# 6. Left Join (Excel Columns = Join Keys)
# ==========================================
if not df_tm1.empty:
    print("--- 4. åŸ·è¡Œ Join ---")
   Â 
    # 1. æµå‡ºæ•¸å€¼æ¬„ä½ (é€šå¸¸ TM1py æœƒæ¯”å€‹å« 'values' æˆ– 'value' æ—¢ column)
    # å°‡ä½¢æ”¹ååš 'tm1_value'
    val_col = 'values' if 'values' in df_tm1.columns else 'value'
    if val_col in df_tm1.columns:
        df_tm1.rename(columns={val_col: 'tm1_value'}, inplace=True)
    else:
        # é˜²å®ˆæ©Ÿåˆ¶ï¼šå¦‚æœæµå””åˆ° value columnï¼Œå°±å‡è¨­æœ€å¾Œä¸€æ¬„ä¿‚æ•¸å€¼
        df_tm1.rename(columns={df_tm1.columns[-1]: 'tm1_value'}, inplace=True)

    # 2. ç¢ºä¿ Join Keys æ ¼å¼ä¸€è‡´ (String)
    # Join Keys å°±ä¿‚ df_master ç›®å‰æ‰€æœ‰æ—¢ columns (åŒ…æ‹¬ measure, time_period)
    join_keys = df_master.columns.tolist()
   Â 
    # ç¢ºä¿ TM1 æ•¸æ“šæ—¢ Keys éƒ½ä¿‚ String
    for col in join_keys:
        if col in df_tm1.columns:
            df_tm1[col] = df_tm1[col].astype(str)

    # 3. ç›´æ¥ Left Join
    final_df = pd.merge(
        df_master,
        df_tm1,
        how='left',
        on=join_keys  # ç›´æ¥ç”¨ Excel æ—¢ Columns åš Key
    )

    # 4. å¡«è£œ 0 (å› ç‚ºç„¡ NON EMPTYï¼Œç†è«–ä¸Š TM1 æœƒæœ‰ 0ï¼Œä½†å¦‚æœå®Œå…¨ç„¡äº¤é›†å°±æœƒä¿‚ NaN)
    final_df['tm1_value'] = final_df['tm1_value'].fillna(0)
   Â 
    final_df.to_csv(OUTPUT_FILE, index=False)
    print(f"ğŸ‰ å®Œæˆï¼File: {OUTPUT_FILE}")
    print(final_df.head())

else:
    print("âš ï¸ TM1 å›å‚³ç©ºæ•¸æ“š (é€™ä¸æ‡‰è©²ç™¼ç”Ÿï¼Œå› ç‚ºç§»é™¤äº† NON EMPTY)ã€‚")
    df_master['tm1_value'] = 0
    df_master.to_csv(OUTPUT_FILE, index=False)
