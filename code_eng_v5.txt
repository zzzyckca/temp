import pandas as pd
from TM1py import TM1Service

# ==========================================
# 1. è¨­å®šå€åŸŸ
# ==========================================
EXCEL_FILE = 'input_params.xlsx'      Â 
OUTPUT_FILE = 'final_result_direct_join.csv' Â 
DERIVED_TIME_PERIOD = 'F2026.01'Â 

TM1_CONFIG = {
    'address': 'localhost',
    'port': 12345,
    'user': 'admin',
    'password': 'password',
    'ssl': True
}
CUBE_NAME = "cb_reporting"Â 

# ==========================================
# 2. è®€å–èˆ‡æ¸…æ´— Excel
# ==========================================
print("--- 1. è®€å– Excel ---")
df_master = pd.read_excel(EXCEL_FILE)
df_master = df_master.astype(str)
df_master.columns = df_master.columns.str.lower().str.strip() # è½‰ç´°æ¥·
df_master = df_master.loc[:, ~df_master.columns.duplicated()] # ç§»é™¤é‡è¤‡æ¬„ä½

# ==========================================
# 3. æ’å…¥ Time Period
# ==========================================
print(f"--- 2. æ’å…¥ Time: {DERIVED_TIME_PERIOD} ---")
df_master['time_period'] = DERIVED_TIME_PERIOD

# ==========================================
# 4. å®šç¾© Mapping (å…¨ç´°æ¥·)
# ==========================================
# å‡è¨­ä½ çš„ Excel æœ‰ä¸€æ¬„å« measureï¼ŒTM1 ä¹Ÿæœ‰ä¸€å€‹ç¶­åº¦å« measure
MEASURE_COL = 'measure'
TM1_MEASURE_DIM = 'measure'

ROW_DIM_MAPPING = {
    'account':                      'account',
    'operating_unit':               'operating_unit',
    'scenario':                     'scenario',
    'time_period':                  'time_period',
    'currency':                     'currency',
    'currency_display':             'currency_display',
    'project':                      'project',
    'product':                      'product',
    'channel':                      'channel',
    'segment':                      'segment',
    'gaap':                         'gaap',
    'counter_party_operating_unit': 'counter_party_operating_unit',
    'amt_type':                     'amt_type',
    'measure':                      'measure' # ğŸ”¥ ç›´æ¥å°‡ Measure ç•¶ä½œæ™®é€šç¶­åº¦è™•ç†
}

# ==========================================
# 5. çµ„è£ MDX
# ==========================================
print("--- 3. çµ„è£ MDX ---")

# é€™è£¡æˆ‘å€‘å°‡ Measure æ”¾å» Rows è»¸å’Œå…¶ä»–ç¶­åº¦ä¸€èµ· CrossJoin
# é€™æ¨£ TM1py å›å‚³çš„ DataFrame å°±æœƒä¿‚: [Account, Dept, ..., Measure, Value]
# é€™å°±æ˜¯ä½ è¦çš„æ ¼å¼ï¼Œä¸éœ€è¦å† Melt
row_mdx_parts = []
for excel_col, tm1_dim in ROW_DIM_MAPPING.items():
    if excel_col in df_master.columns:
        unique_items = [str(x) for x in df_master[excel_col].unique() if pd.notna(x) and str(x).strip() != '']
        if unique_items:
            # å»ºç«‹ Set: {[Dim].[Item1], [Dim].[Item2]}
            mdx_set = "{" + ",".join([f"[{tm1_dim}].[{item}]" for item in unique_items]) + "}"
            row_mdx_parts.append(mdx_set)

row_mdx_str = " * ".join(row_mdx_parts)

# ç‚ºäº†è®“ TM1py å›å‚³ Tidy Format (é•·è¡¨)ï¼Œæˆ‘å€‘é€šå¸¸æŠŠæ‰€æœ‰ç¶­åº¦æ”¾ Rows
# Columns åªæ”¾ä¸€å€‹ Dummy æˆ–è€…ç©ºçš„
mdx_query = f"""
SELECT
    {{ }} ON COLUMNS,Â 
    NON EMPTY
    ( {row_mdx_str} ) ON ROWS
FROM [{CUBE_NAME}]
"""

# ==========================================
# 6. åŸ·è¡ŒæŸ¥è©¢
# ==========================================
print("--- 4. é€£ç·š TM1 ---")
df_tm1 = pd.DataFrame()

with TM1Service(**TM1_CONFIG) as tm1:
    # ä½¿ç”¨ execute_mdx_dataframe (é è¨­å·²ç¶“æœƒå¹«ä½ ç”± MDX table è½‰åš pandas dataframe)
    df_tm1 = tm1.cells.execute_mdx_dataframe(mdx_query)
   Â 
    # Reset Index: æŠŠ Dimensions è®Šæˆæ™®é€š Columns
    df_tm1 = df_tm1.reset_index()
   Â 
    # è½‰ç´°æ¥·
    df_tm1.columns = df_tm1.columns.str.lower().str.strip()
   Â 
    # ğŸ”¥ é—œéµæª¢æŸ¥ï¼šå°å‡º TM1 å›å‚³çš„ Columns çœ‹çœ‹
    print(f"TM1 Columns: {df_tm1.columns.tolist()}")
    # é æœŸçµæœ: ['account', 'operating_unit', ..., 'measure', 'value']

# ==========================================
# 7. ç›´æ¥ Merge (No Melt)
# ==========================================
if not df_tm1.empty:
    print("--- 5. ç›´æ¥ Merge ---")
   Â 
    # æ‰¾å‡ºæ•¸å€¼æ¬„ä½ (é€šå¸¸å« 'value' æˆ– 'values')
    # æˆ‘å€‘æŠŠå®ƒæ”¹ååš 'tm1_value' é¿å…æ’å
    value_col = None
    for col in ['value', 'values']:
        if col in df_tm1.columns:
            value_col = col
            break
           Â 
    if value_col:
        df_tm1.rename(columns={value_col: 'tm1_value'}, inplace=True)
    else:
        # å¦‚æœæ‰¾ä¸åˆ° value columnï¼Œå¯èƒ½å…¨éƒ¨éƒ½ä¿‚ç¶­åº¦åï¼Œæœ€å¾Œä¸€å€‹å¯èƒ½ä¿‚æ•¸å€¼
        # é€™è£¡åšä¸€å€‹é˜²å®ˆæ€§ logic
        df_tm1.rename(columns={df_tm1.columns[-1]: 'tm1_value'}, inplace=True)

    # ç¢ºä¿å…¨éƒ¨ String (é™¤äº†æ•¸å€¼)
    for col in df_tm1.columns:
        if col != 'tm1_value':
            df_tm1[col] = df_tm1[col].astype(str)

    # æº–å‚™ Keys (å·¦å³å…©é‚Šæ—¢ Keys æ‡‰è©²è¦ä¸€æ¨£)
    # é€™è£¡ç›´æ¥ç”¨ Mapping çš„ Keysï¼Œå› ç‚ºæˆ‘å€‘å‡è¨­ TM1py å›å‚³çš„ column names ç­‰æ–¼ Dimension names (ç´°æ¥·)
    join_keys = list(ROW_DIM_MAPPING.values())
   Â 
    # å†æ¬¡ç¢ºèªé€™äº› Keys çœŸçš„å­˜åœ¨æ–¼ df_tm1 ä¸­
    valid_join_keys = [k for k in join_keys if k in df_tm1.columns]

    print(f"ç”¨ä½œ Join çš„ Keys: {valid_join_keys}")

    # Left Join
    final_df = pd.merge(
        df_master,
        df_tm1,
        how='left',
        on=valid_join_keys # å› ç‚ºå·¦å³åä¸€æ¨£ (ç´°æ¥·)ï¼Œç›´æ¥ç”¨ on å°±å¾—
    )

    # å¡«è£œ 0
    final_df['tm1_value'] = final_df['tm1_value'].fillna(0)
   Â 
    final_df.to_csv(OUTPUT_FILE, index=False)
    print(f"ğŸ‰ å®Œæˆï¼File: {OUTPUT_FILE}")

else:
    print("âš ï¸ TM1 ç„¡æ•¸æ“šï¼Œå¡« 0 è¼¸å‡ºã€‚")
    df_master['tm1_value'] = 0
    df_master.to_csv(OUTPUT_FILE, index=False)

