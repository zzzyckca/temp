import pandas as pd
from TM1py import TM1Service

# ==========================================
# 1. è¨­å®šå€åŸŸ (Configuration)
# ==========================================
EXCEL_FILE = 'input_params.xlsx'      Â 
OUTPUT_FILE = 'final_result_linear.csv' Â 

# Python è‡ªå‹•å¡«å…¥çš„æ™‚é–“
DERIVED_TIME_PERIOD = 'F2026.01'Â 

# TM1 é€£ç·šè³‡è¨Š
TM1_CONFIG = {
    'address': 'localhost',  # ğŸ”‘ IP
    'port': 12345,           # ğŸ”‘ HTTPPort
    'user': 'admin',
    'password': 'password',
    'ssl': True
}

CUBE_NAME = "cb_reporting"Â 

# ==========================================
# 2. è®€å– Excel ä¸¦å¼·åŠ›æ¸…æ´— (Fix Duplicate Columns)
# ==========================================
print("--- 1. è®€å– Excel ---")
df_master = pd.read_excel(EXCEL_FILE)
df_master = df_master.astype(str)

# ğŸ”¥ è½‰ç´°æ¥· + å»é™¤å‰å¾Œç©ºç™½
df_master.columns = df_master.columns.str.lower().str.strip()

# ğŸ”¥ é—œéµä¿®å¾©: ç§»é™¤é‡è¤‡çš„ Header (ä¾‹å¦‚æœ‰å…©å€‹ measure)
df_master = df_master.loc[:, ~df_master.columns.duplicated()]
print(f"Excel Columns: {df_master.columns.tolist()}")

# ==========================================
# 3. æ’å…¥ Time_Period
# ==========================================
print(f"--- 2. æ’å…¥ Time_Period: {DERIVED_TIME_PERIOD} ---")
df_master['time_period'] = DERIVED_TIME_PERIOD

# ==========================================
# 4. å®šç¾© Mapping (å…¨ç´°æ¥·)
# ==========================================
# å·¦é‚Š Key è·Ÿ Excel Headerï¼Œå³é‚Š Value è·Ÿ TM1 Dimension
MEASURE_COL_EXCEL = 'measure'
MEASURE_DIM_TM1   = 'measure'

ROW_DIM_MAPPING = {
    'account':                      'account',
    'operating_unit':               'operating_unit',
    'scenario':                     'scenario',
    'time_period':                  'time_period', # å‰›åŠ é€²å»çš„
    'currency':                     'currency',
    'currency_display':             'currency_display',
    'project':                      'project',
    'product':                      'product',
    'channel':                      'channel',
    'segment':                      'segment',
    'gaap':                         'gaap',
    'counter_party_operating_unit': 'counter_party_operating_unit',
    'amt_type':                     'amt_type'
}

# ==========================================
# 5. å‹•æ…‹çµ„è£ MDX (Inline Logic)
# ==========================================
print("--- 3. çµ„è£ MDX ---")

# A. è™•ç† Measure (Columns è»¸)
# ç›´æ¥ç”¨ List Comprehension è½‰ MDX Set æ ¼å¼
unique_measures = [str(x) for x in df_master[MEASURE_COL_EXCEL].unique() if pd.notna(x) and str(x).strip() != '']
str_measures = "{" + ",".join([f"[{MEASURE_DIM_TM1}].[{item}]" for item in unique_measures]) + "}"

# B. è™•ç† Rows è»¸ (å…¶ä»–ç¶­åº¦)
row_mdx_parts = []
for excel_col, tm1_dim in ROW_DIM_MAPPING.items():
    if excel_col in df_master.columns:
        # è½‰ MDX Set
        unique_items = [str(x) for x in df_master[excel_col].unique() if pd.notna(x) and str(x).strip() != '']
        if unique_items:
            mdx_set = "{" + ",".join([f"[{tm1_dim}].[{item}]" for item in unique_items]) + "}"
            row_mdx_parts.append(mdx_set)

row_mdx_str = " * ".join(row_mdx_parts)

# C. å®Œæ•´ MDX
mdx_query = f"""
SELECT
    {str_measures} ON COLUMNS,
    NON EMPTY
    ( {row_mdx_str} ) ON ROWS
FROM [{CUBE_NAME}]
"""

# ==========================================
# 6. åŸ·è¡ŒæŸ¥è©¢
# ==========================================
print("--- 4. é€£ç·š TM1 ---")
df_tm1 = pd.DataFrame() # åˆå§‹åŒ–ç©º DataFrame ä»¥é˜²é€£ç·šå¤±æ•—

with TM1Service(**TM1_CONFIG) as tm1:
    df_tm1 = tm1.cells.execute_mdx_dataframe(mdx_query)
    # Reset Index
    df_tm1 = df_tm1.reset_index()
    # æ¸…æ´— TM1 å›å‚³çš„ Columns
    df_tm1.columns = df_tm1.columns.str.lower().str.strip()
    print(f"TM1 å›å‚³è¡Œæ•¸: {len(df_tm1)}")

# ==========================================
# 7. æ•¸æ“šè™•ç† (Melt & Merge)
# ==========================================
if not df_tm1.empty:
    print("--- 5. æ•´ç†æ•¸æ“š ---")
   Â 
    # A. æº–å‚™ ID Vars (æ‰¾å‡ºé Measure Value çš„æ¬„ä½)
    excel_measure_values = [x.lower() for x in df_master[MEASURE_COL_EXCEL].unique()]
    id_vars = [col for col in df_tm1.columns if col not in excel_measure_values]

    # B. Melt (è½‰ç›´) - ğŸ”¥ é¿é–‹æ’åï¼Œç”¨ 'measure_temp'
    df_tm1_long = df_tm1.melt(
        id_vars=id_vars,Â 
        var_name='measure_temp',  # <--- æš«æ™‚æ”¹å
        value_name='tm1_value'Â 
    )
   Â 
    # ç¢ºä¿å…¨éƒ¨ String æ ¼å¼
    for col in df_tm1_long.columns:
         df_tm1_long[col] = df_tm1_long[col].astype(str)

    # C. æº–å‚™ Merge Keys
    left_keys = list(ROW_DIM_MAPPING.keys()) + [MEASURE_COL_EXCEL]
    right_keys = list(ROW_DIM_MAPPING.values()) + ['measure_temp'] # å°æ‡‰ä¸Šé¢çš„ temp å

    # D. Left Join
    final_df = pd.merge(
        df_master,
        df_tm1_long,
        how='left',
        left_on=left_keys,
        right_on=right_keys
    )

    # E. å¡«è£œ 0
    final_df['tm1_value'] = final_df['tm1_value'].fillna(0)
   Â 
    # F. è¼¸å‡º
    final_df.to_csv(OUTPUT_FILE, index=False)
    print(f"ğŸ‰ å®Œæˆï¼File: {OUTPUT_FILE}")

else:
    print("âš ï¸ TM1 ç„¡æ•¸æ“šï¼Œå¡« 0 è¼¸å‡ºã€‚")
    df_master['tm1_value'] = 0
    df_master.to_csv(OUTPUT_FILE, index=False)
