import pandas as pd
from TM1py import TM1Service

# ==========================================
# 1. è¨­å®šå€åŸŸ
# ==========================================
EXCEL_FILE = 'input_params.xlsx'      Â 
OUTPUT_FILE = 'final_result_direct.csv'
DERIVED_TIME_PERIOD = 'F2026.01'Â 

TM1_CONFIG = {
    'address': 'localhost',
    'port': 12345,
    'user': 'admin',
    'password': 'password',
    'ssl': True
}
CUBE_NAME = "cb_reporting"Â 

# ==========================================
# 2. æº–å‚™ Excel (Master Table)
# ==========================================
print("--- 1. è®€å– Excel ---")
df_master = pd.read_excel(EXCEL_FILE)
df_master = df_master.astype(str)

# æ¸…æ´— Header: è½‰ç´°æ¥· + å»ç©ºæ ¼
df_master.columns = df_master.columns.str.lower().str.strip()
# ç§»é™¤é‡è¤‡ Columns (é˜²å‘†)
df_master = df_master.loc[:, ~df_master.columns.duplicated()]

# æ’å…¥ Time
print(f"æ’å…¥ Time Period: {DERIVED_TIME_PERIOD}")
df_master['time_period'] = DERIVED_TIME_PERIOD

print(f"Join Keys (Excel Columns): {df_master.columns.tolist()}")

# ==========================================
# 3. å®šç¾© Mapping
# ==========================================
# ğŸ”¥ é—œéµï¼šå°‡ 'measure' æ”¾å…¥å»ï¼Œç•¶ä½œæ™®é€šç¶­åº¦è™•ç†
ROW_DIM_MAPPING = {
    'account':                      'account',
    'operating_unit':               'operating_unit',
    'scenario':                     'scenario',
    'time_period':                  'time_period',
    'currency':                     'currency',
    'currency_display':             'currency_display',
    'project':                      'project',
    'product':                      'product',
    'channel':                      'channel',
    'segment':                      'segment',
    'gaap':                         'gaap',
    'counter_party_operating_unit': 'counter_party_operating_unit',
    'amt_type':                     'amt_type',
    'measure':                      'measure'  # <--- Measure æ”¾ä¿‚åº¦
}

# ==========================================
# 4. çµ„è£ MDX (å…¨éƒ¨æ”¾ Rows)
# ==========================================
print("--- 2. çµ„è£ MDX (No NON EMPTY) ---")

row_mdx_parts = []
for excel_col, tm1_dim in ROW_DIM_MAPPING.items():
    if excel_col in df_master.columns:
        # å»ºç«‹ Set: {[Dim].[Item1], [Dim].[Item2]}
        unique_items = [str(x) for x in df_master[excel_col].unique() if pd.notna(x) and str(x).strip() != '']
        if unique_items:
            mdx_set = "{" + ",".join([f"[{tm1_dim}].[{item}]" for item in unique_items]) + "}"
            row_mdx_parts.append(mdx_set)

# CrossJoin
row_mdx_str = " * ".join(row_mdx_parts)

# ğŸ”¥ çµæ§‹ï¼šColumns ç©ºï¼ŒRows æ”¾æ‰€æœ‰é‡ (åŒ…æ‹¬ Measure)
# ğŸ”¥ åˆªé™¤äº† NON EMPTY
mdx_query = f"""
SELECT
    {{ }} ON 0,
    ( {row_mdx_str} ) ON 1
FROM [{CUBE_NAME}]
"""

# ==========================================
# 5. åŸ·è¡ŒæŸ¥è©¢
# ==========================================
print("--- 3. é€£ç·š TM1 ---")
df_tm1 = pd.DataFrame()

with TM1Service(**TM1_CONFIG) as tm1:
    # åŸ·è¡Œ Query
    # å› ç‚º Measure åœ¨ Rowsï¼Œå›å‚³çµæ§‹æœƒä¿‚: [Account, ..., Measure, Values]
    df_tm1 = tm1.cells.execute_mdx_dataframe(mdx_query)
   Â 
    # Reset Index (Dimensions è®Š Columns)
    df_tm1 = df_tm1.reset_index()
   Â 
    # è½‰ç´°æ¥· (ç¢ºä¿åŒ Excel ä¸€è‡´)
    df_tm1.columns = df_tm1.columns.str.lower().str.strip()
   Â 
    print(f"TM1 Columns: {df_tm1.columns.tolist()}")

# ==========================================
# 6. ç›´æ¥ Merge (Excel Columns = Join Keys)
# ==========================================
if not df_tm1.empty:
    print("--- 4. ç›´æ¥ Join ---")
   Â 
    # 1. è™•ç†æ•¸å€¼æ¬„ä½å
    # TM1py é€šå¸¸å›å‚³ 'values' æˆ– 'value'ï¼Œæ”¹ååš 'tm1_value'
    val_col = None
    for col in ['values', 'value']:
        if col in df_tm1.columns:
            val_col = col
            break
   Â 
    if val_col:
        df_tm1.rename(columns={val_col: 'tm1_value'}, inplace=True)
    else:
        # å¦‚æœæ‰¾ä¸åˆ°ï¼Œæœ€å¾Œä¸€æ¬„é€šå¸¸ä¿‚æ•¸å€¼
        df_tm1.rename(columns={df_tm1.columns[-1]: 'tm1_value'}, inplace=True)

    # 2. ç¢ºä¿ Join Keys å…¨éƒ¨ä¿‚ String
    # Join Keys å°±ä¿‚ Excel ç›®å‰æœ‰æ—¢ columns
    join_keys = df_master.columns.tolist()
   Â 
    for col in join_keys:
        if col in df_tm1.columns:
            df_tm1[col] = df_tm1[col].astype(str)

    # 3. Left Join
    final_df = pd.merge(
        df_master,
        df_tm1,
        how='left',
        on=join_keys # ç›´æ¥ç”¨ Excel Columns åš Key
    )

    # 4. å¡«è£œ 0
    final_df['tm1_value'] = final_df['tm1_value'].fillna(0)
   Â 
    final_df.to_csv(OUTPUT_FILE, index=False)
    print(f"ğŸ‰ å®Œæˆï¼File: {OUTPUT_FILE}")
    print(final_df.head())

else:
    print("âš ï¸ TM1 å›å‚³ç©ºæ•¸æ“š (è«‹æª¢æŸ¥ Mapping æ˜¯å¦æœ‰éŒ¯å­—)ã€‚")
    df_master['tm1_value'] = 0
    df_master.to_csv(OUTPUT_FILE, index=False)
