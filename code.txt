import win32com.client
import pythoncom
import os
import shutil
import pandas as pd
from prefect import flow, task
from datetime import datetime

# --- è¨­å®š ---
CONFIG_FILE_PATH = r"C:\Work\config.xlsx" # ä½ çš„ Excel Config ä½ç½®
TEMP_FOLDER = r"C:\Work\Temp"             # æš«å­˜é™„ä»¶ä½ç½®
DEFAULT_FOLDER = r"C:\Work\Unsorted"      # å¦‚æœ Excel ç„¡å°æ‡‰è¦å‰‡ï¼Œå»å‘¢åº¦
TARGET_SUBJECT = "TRIGGER_ME"             # ç›£è½éƒµä»¶æ¨™é¡Œ

# ç¢ºä¿ Folder å­˜åœ¨
for f in [TEMP_FOLDER, DEFAULT_FOLDER]:
    os.makedirs(f, exist_ok=True)

@task(name="Load Config")
def load_config_rules():
    """
    è®€å– Excel Config Fileï¼Œå›å‚³ä¸€å€‹ DataFrame
    """
    try:
        df = pd.read_excel(CONFIG_FILE_PATH)
        # è½‰åš Dictionary æ–¹ä¾¿ä¹‹å¾Œ lookupï¼Œä¾‹å¦‚: [{'Keyword': 'Invoice', 'Folder': 'C:\\...'}]
        rules = df.to_dict('records') 
        print(f"ğŸ“‹ Loaded {len(rules)} rules from Excel.")
        return rules
    except Exception as e:
        print(f"âŒ Error reading config excel: {e}")
        return []

@task(name="Process Attachments")
def save_and_route_attachments(message_item, rules):
    """
    ä¸‹è¼‰é™„ä»¶ -> å°ç…§ Rules -> æ¬å»ç›®çš„åœ°
    """
    # å‘¢å€‹ task å¯èƒ½æœƒå–ºå¦ä¸€å€‹ thread è·‘ï¼Œå¦‚æœä½ ç”¨ .serve
    # ä½†å› ç‚ºæˆ‘åœ°ä¿‚ pass `message_item` object (COM Object) å…¥é»ï¼Œ
    # è·¨ thread ç”¨ COM object ä¿‚æ¥µå±éšªã€‚
    # **æ”¹è‰¯ç­–ç•¥**ï¼šæœ€å¥½ä¿‚å–º Main Logic åšå®Œ win32com æ“ä½œï¼Œåª pass filePath string ä¿¾ Taskã€‚
    # ä¸éç‚ºå·¦ç°¡å–®ç¤ºç¯„ï¼Œæˆ‘åœ°å‡è¨­é€™æ˜¯å–®ç·šç¨‹ï¼Œæˆ–è€…åœ¨ flow å…§ç›´æ¥æ“ä½œã€‚
    
    # æª¢æŸ¥æœ‰ç„¡é™„ä»¶
    if message_item.Attachments.Count == 0:
        print("No attachments found.")
        return

    for i in range(1, message_item.Attachments.Count + 1):
        attachment = message_item.Attachments.Item(i)
        filename = attachment.FileName
        print(f"ğŸ“ Processing file: {filename}")

        # 1. å…ˆ Save å» Temp Folder
        temp_path = os.path.join(TEMP_FOLDER, filename)
        # win32com éœ€è¦å®Œæ•´çµ•å°è·¯å¾‘ (Absolute Path)
        attachment.SaveAsFile(temp_path)

        # 2. Check Excel Rules (ç°¡å–®é‚è¼¯ï¼šæª”ååŒ…å« Keyword)
        destination = DEFAULT_FOLDER
        matched_rule = False

        for rule in rules:
            keyword = str(rule.get('Keyword', '')).lower()
            target_dir = rule.get('Destination_Folder')
            
            # é‚è¼¯æ ¸å¿ƒï¼šå¦‚æœ Keyword å–º æª”å å…¥é¢
            if keyword in filename.lower():
                destination = target_dir
                matched_rule = True
                print(f"âœ… Matched Rule: '{keyword}' -> {destination}")
                break # æµåˆ°å°±åœ
        
        # 3. æ¬é‹æª”æ¡ˆ (Move)
        try:
            # ç¢ºä¿ç›®æ¨™ Folder å­˜åœ¨
            os.makedirs(destination, exist_ok=True)
            
            final_path = os.path.join(destination, filename)
            
            # å¦‚æœç›®æ¨™å·²æœ‰åŒåæª”ï¼Œé€™è£¡æœƒ Errorï¼Œä½ å¯ä»¥åŠ  timestamp è§£æ±ºï¼Œé€™è£¡å¾ç°¡
            shutil.move(temp_path, final_path)
            print(f"ğŸšš Moved to: {final_path}")
            
        except Exception as e:
            print(f"âŒ Error moving file: {e}")


@flow(name="Excel_Router_Flow", log_prints=True)
def email_router_flow():
    pythoncom.CoInitialize() # å¿…åŠ 
    
    try:
        # 1. é€£æ¥ Outlook
        outlook = win32com.client.Dispatch("Outlook.Application").GetNamespace("MAPI")
        inbox = outlook.GetDefaultFolder(6)
        
        # 2. è®€å– Excel Config
        rules = load_config_rules()
        
        # 3. æµä¿¡
        messages = inbox.Items.Restrict(f"[UnRead] = True AND [Subject] = '{TARGET_SUBJECT}'")
        
        # 4. è™•ç†æ¯ä¸€å°ä¿¡
        # æ³¨æ„ï¼šwin32com collection æœ€å¥½è½‰åš list å…ˆ loopï¼Œé¿å… index shift
        for msg in list(messages):
            print(f"ğŸ“§ New Email: {msg.Subject}")
            
            # è™•ç†è©²ä¿¡ä»¶çš„æ‰€æœ‰é™„ä»¶
            save_and_route_attachments(msg, rules)
            
            # 5. Mark å·²è®€ & ç§»èµ° (Cleanup)
            msg.UnRead = False
            # msg.Move(inbox.Folders("Processed")) # Optional: å»ºè­°ç§»èµ°
            
    except Exception as e:
        print(f"Flow Error: {e}")
    finally:
        pythoncom.CoUninitialize()

if __name__ == "__main__":
    # æ¯ 1 åˆ†é˜ Check ä¸€æ¬¡
    print("ğŸš€ Starting Outlook File Router...")
    email_router_flow.serve(name="file-router-v1", interval=60)