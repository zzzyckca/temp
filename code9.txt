import pandas as pd
from TM1py import TM1Service

# ==========================================
# 1. è¨­å®šå€åŸŸ
# ==========================================
# ä½ çš„ Excel æª”æ¡ˆ (åªæœ‰ Parametersï¼Œæ²’æœ‰ Value)
EXCEL_FILE = 'input_params.xlsx'      Â 
OUTPUT_FILE = 'final_result_joined.csv'

# ç¡¬æ€§è¦å®šçš„ Time Period
DERIVED_TIME_PERIOD = 'F2026.01'Â 

TM1_CONFIG = {
    'address': 'localhost',
    'port': 12345,
    'user': 'admin',
    'password': 'password',
    'ssl': True
}
CUBE_NAME = "cb_reporting"Â 

# ==========================================
# 2. æº–å‚™ Excel Parameters
# ==========================================
print("--- 1. è®€å–ä¸¦æ•´ç† Excel Parameters ---")
df_master = pd.read_excel(EXCEL_FILE)
df_master = df_master.astype(str)

# 1. å…¨éƒ¨è½‰ç´°æ¥· + å»ç©ºæ ¼ (é€™æ˜¯æœ€ç©©é™£çš„ Join æ–¹æ³•)
df_master.columns = df_master.columns.str.lower().str.strip()

# 2. å¼·åˆ¶ç§»é™¤é‡è¤‡æ¬„ä½ (è§£æ±º 'label not unique' çš„æ ¹æº)
df_master = df_master.loc[:, ~df_master.columns.duplicated()]

# 3. æ’å…¥ Time Period
df_master['time_period'] = DERIVED_TIME_PERIOD.lower() # ä¿æŒç´°æ¥·ä¸€è‡´æ€§

# 4. ç¢ºä¿ Excel è£¡çš„å…§å®¹ä¹Ÿæ˜¯ clean çš„ string
# ç‰¹åˆ¥æ˜¯ measure é€™ä¸€æ¬„ï¼Œå› ç‚ºå®ƒæ˜¯ MDX çš„é—œéµ
if 'measure' in df_master.columns:
    df_master['measure'] = df_master['measure'].str.strip()

print(f"Excel Columns (Join Keys): {df_master.columns.tolist()}")

# ==========================================
# 3. å®šç¾© Mapping
# ==========================================
# æ ¹æ“šä½ çš„ MDX çµæ§‹ï¼šMeasure on Columns, å…¶ä»– on Rows
MEASURE_COL = 'measure'

# é€™è£¡åˆ—å‡ºæ‰€æœ‰æ”¾åœ¨ ROWS çš„ç¶­åº¦
ROW_DIM_MAPPING = {
    'account':                      'account',
    'operating_unit':               'operating_unit',
    'scenario':                     'scenario',
    'time_period':                  'time_period',
    'currency':                     'currency',
    'currency_display':             'currency_display',
    'project':                      'project',
    'product':                      'product',
    'channel':                      'channel',
    'segment':                      'segment',
    'gaap':                         'gaap',
    'counter_party_operating_unit': 'counter_party_operating_unit',
    'amt_type':                     'amt_type'
}

# ==========================================
# 4. å‹•æ…‹çµ„è£ MDX (On Columns / On Rows)
# ==========================================
print("--- 2. çµ„è£ MDX ---")

# A. è™•ç† Measure (ON COLUMNS)
# æŠ“å‡º Excel è£¡ unique çš„ measure (ä¾‹å¦‚ Mx_2)
unique_measures = [x for x in df_master[MEASURE_COL].unique() if x and x.lower() != 'nan']
# å‡è¨­ TM1 ç¶­åº¦åä¹Ÿæ˜¯ measure
str_measures = "{" + ",".join([f"[measure].[{item}]" for item in unique_measures]) + "}"

# B. è™•ç† å…¶ä»–ç¶­åº¦ (ON ROWS)
row_mdx_parts = []
for excel_col, tm1_dim in ROW_DIM_MAPPING.items():
    if excel_col in df_master.columns:
        unique_items = [x for x in df_master[excel_col].unique() if x and x.lower() != 'nan']
        if unique_items:
            mdx_set = "{" + ",".join([f"[{tm1_dim}].[{item}]" for item in unique_items]) + "}"
            row_mdx_parts.append(mdx_set)

row_mdx_str = " * ".join(row_mdx_parts)

# C. å®Œæ•´ MDX (ä¿ç•™ä½ æƒ³è¦çš„çµæ§‹)
# æ³¨æ„ï¼šé€™è£¡ ON 0 æ˜¯ Columns, ON 1 æ˜¯ Rows
mdx_query = f"""
SELECT
    {str_measures} ON 0,
    ( {row_mdx_str} ) ON 1
FROM [{CUBE_NAME}]
"""

# ==========================================
# 5. åŸ·è¡ŒæŸ¥è©¢
# ==========================================
print("--- 3. é€£ç·š TM1 åŸ·è¡ŒæŸ¥è©¢ ---")
df_tm1 = pd.DataFrame()

with TM1Service(**TM1_CONFIG) as tm1:
    df_tm1 = tm1.cells.execute_mdx_dataframe(mdx_query)
   Â 
    # 1. Reset Index (æŠŠ Dimensions è®Šæˆæ™®é€š Columns)
    df_tm1 = df_tm1.reset_index()
   Â 
    # 2. è½‰ç´°æ¥· (ç¢ºä¿åŒ Excel ä¸€æ¨£)
    df_tm1.columns = df_tm1.columns.str.lower().str.strip()
   Â 
    print(f"TM1 Columns: {df_tm1.columns.tolist()}")

# ==========================================
# 6. æ•´ç†æ•¸æ“š & Join (é—œéµä¸€æ­¥)
# ==========================================
if not df_tm1.empty:
    print("--- 4. æ•´ç†æ•¸æ“š & Merge ---")

    # [æƒ…å¢ƒåˆ†æ]
    # ç•¶ Measure åœ¨ Columns æ™‚ï¼ŒTM1py å›å‚³çš„çµæœï¼Œæ•¸å€¼æ¬„ä½åç¨±é€šå¸¸å°±æ˜¯é‚£å€‹ Measure çš„åå­— (ä¾‹å¦‚ 'mx_2' æˆ– 'value')
    # ä½ çš„æˆªåœ–é¡¯ç¤ºå›å‚³äº† 'Value'ã€‚
   Â 
    # 1. æ‰¾å‡ºæ•¸å€¼æ¬„ä½ä¸¦æ”¹ååš 'tm1_value'
    # é€™æ¨£å¯ä»¥é¿å…è·Ÿ Excel åŸæœ¬çš„æ¬„ä½æ’å
    target_val_col = None
   Â 
    # å„ªå…ˆæ‰¾ 'value', 'values'
    for col in ['value', 'values']:
        if col in df_tm1.columns:
            target_val_col = col
            break
           Â 
    # å¦‚æœæ‰¾ä¸åˆ°ï¼Œå°±æ‰¾ measure çš„åå­— (ä¾‹å¦‚ mx_2)
    if not target_val_col:
        for m in unique_measures:
            if m.lower() in df_tm1.columns:
                target_val_col = m.lower()
                break
   Â 
    # å¦‚æœé‚„æ˜¯æ‰¾ä¸åˆ°ï¼Œæ‹¿æœ€å¾Œä¸€æ¬„ç•¶ä½œæ•¸å€¼
    if not target_val_col:
         target_val_col = df_tm1.columns[-1]

    print(f"é–å®šæ•¸å€¼æ¬„ä½: {target_val_col} -> æ”¹åç‚º 'tm1_value'")
    df_tm1.rename(columns={target_val_col: 'tm1_value'}, inplace=True)

    # 2. æº–å‚™ Join Keys
    # æˆ‘å€‘åªç”¨ Dimensions ä¾†å°æ¥ (Account, Org...)
    # é€™æ¨£å¯ä»¥é¿é–‹ 'measure' é€™ä¸€æ¬„çš„æ··äº‚
    join_keys = [col for col in ROW_DIM_MAPPING.keys() if col in df_master.columns]
   Â 
    # ç¢ºä¿å…©é‚Šçš„ Join Keys éƒ½æ˜¯ String æ ¼å¼
    for col in join_keys:
        if col in df_tm1.columns:
            df_tm1[col] = df_tm1[col].astype(str)

    # 3. åŸ·è¡Œ Left Join
    # Excel æ˜¯ä¸»è¡¨ï¼ŒTM1 æ˜¯æŸ¥è¡¨
    final_df = pd.merge(
        df_master,
        df_tm1[join_keys + ['tm1_value']], # åªå–éœ€è¦çš„æ¬„ä½ Mergeï¼Œé¿å…å¸¶å…¥å¤šé¤˜çš„ columns
        how='left',
        on=join_keys
    )

    # 4. å¡«è£œç©ºå€¼
    final_df['tm1_value'] = final_df['tm1_value'].fillna(0)
   Â 
    print("Sample Result:")
    print(final_df.head())
   Â 
    final_df.to_csv(OUTPUT_FILE, index=False)
    print(f"ğŸ‰ æˆåŠŸï¼æª”æ¡ˆå·²å„²å­˜: {OUTPUT_FILE}")

else:
    print("âš ï¸ TM1 å›å‚³ç©ºæ•¸æ“šï¼Œè«‹æª¢æŸ¥ MDX æˆ–æ¬Šé™ã€‚")

