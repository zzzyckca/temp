import pandas as pd
from TM1py import TM1Service

# ==========================================
# 1. Ë®≠ÂÆöÂçÄÂüü (Configuration)
# ==========================================
EXCEL_FILE = 'input_params.xlsx'       # ‰Ω†ÁöÑ Input Excel
OUTPUT_FILE = 'final_result.csv'       # ‰Ω†ÁöÑ Output CSV
DERIVED_TIME_PERIOD = 'F2026.01'       # Python Ëá™ÂãïÂ°´ÁöÑÊôÇÈñì

TM1_CONFIG = {
    'address': 'localhost',
    'port': 12345,
    'user': 'admin',
    'password': 'password',
    'ssl': True
}
CUBE_NAME = "cb_reporting"

# ==========================================
# 2. Ê∫ñÂÇô Excel (Master Table)
# ==========================================
print("--- 1. Reading Excel file ---")
# ËÆÄÂèñ Excel
try:
    df_master = pd.read_excel(EXCEL_FILE)
except Exception as e:
    print(f"‚ùå ÁÑ°Ê≥ïËÆÄÂèñ Excel: {e}")
    exit()

# Âº∑Âà∂ÂÖ®ÈÉ®ËΩâ String (ÈÅøÂÖç Account 123 ËÆäÊàêÊï∏Â≠ó 123)
df_master = df_master.astype(str)

# üî• Ê∏ÖÊ¥ó Columns: ËΩâÁ¥∞Ê•∑ + ÂéªÁ©∫Ê†º (Ë∑ü TM1 ÂõûÂÇ≥ÁöÑÊ†ºÂºèÂ∞çÈΩä)
df_master.columns = df_master.columns.str.lower().str.strip()

# üî• Èò≤ÂëÜ: ÁßªÈô§ÈáçË§á Columns (Ë≤ª‰∫ãÈÄô‰∏ÄÊ≠•Â†±ÈåØ)
df_master = df_master.loc[:, ~df_master.columns.duplicated()]

# ÊèíÂÖ• Time Period
print(f"Adding Time_Period: {DERIVED_TIME_PERIOD}")
df_master['time_period'] = DERIVED_TIME_PERIOD

print(f"Excel Columns (Join Keys): {df_master.columns.tolist()}")

# ==========================================
# 3. ÂÆöÁæ© Mapping
# ==========================================
# Â∑¶ÈÇä: Excel Column Header (Â∑≤ËΩâÁ¥∞Ê•∑)
# Âè≥ÈÇä: TM1 Dimension Name
# ‚ö†Ô∏è Ê†πÊìö‰Ω†ÁöÑÊà™ÂúñÔºåTM1 ÂõûÂÇ≥ÁöÑÂÖ®ÈÉ®ÈÉΩ‰øÇÁ¥∞Ê•∑ÔºåÊâÄ‰ª•ÈÄôË£°ÂÖ®ÈÉ®Áî®Á¥∞Ê•∑ÊúÄÁ©©Èô£
ROW_DIM_MAPPING = {
    'account':                      'account',
    'operating_unit':               'operating_unit',
    'scenario':                     'scenario',
    'time_period':                  'time_period',
    'currency':                     'currency',
    'currency_display':             'currency_display',
    'project':                      'project',
    'product':                      'product',
    'channel':                      'channel',
    'segment':                      'segment',
    'gaap':                         'gaap',
    'counter_party_operating_unit': 'counter_party_operating_unit',
    'amt_type':                     'amt_type',
    'measure':                      'measure'  # ‰Ω†ÁöÑÊà™ÂúñÈ°ØÁ§∫ measure ‰πüÊòØ‰∏ÄÂÄã column
}

# ==========================================
# 4. ÁµÑË£ù MDX (Batch Query)
# ==========================================
print("--- 2. Constructing MDX ---")

row_mdx_parts = []
valid_keys = [] # Áî®‰æÜË®òÈåÑÂì™‰∫õÊ¨Ñ‰ΩçÁúüÁöÑÊúÉÁî®‰æÜÂÅö Join

for excel_col, tm1_dim in ROW_DIM_MAPPING.items():
    if excel_col in df_master.columns:
        # Êãé Unique Values ÂÅö MDX Set
        unique_items = [str(x) for x in df_master[excel_col].unique() if x and str(x).lower() != 'nan']
       ¬†
        if unique_items:
            # { [Dim].[Item1], [Dim].[Item2] }
            mdx_set = "{" + ",".join([f"[{tm1_dim}].[{item}]" for item in unique_items]) + "}"
            row_mdx_parts.append(mdx_set)
            valid_keys.append(excel_col) # Ë®ò‰ΩéÈÄôÂÄã Key

# CrossJoin
row_mdx_str = " * ".join(row_mdx_parts)

# Query: Columns ÊîæÁ©∫ {}, Rows ÊîæÊâÄÊúâÁ∂≠Â∫¶
mdx_query = f"""
SELECT
    {{ }} ON 0,
    ( {row_mdx_str} ) ON 1
FROM [{CUBE_NAME}]
"""

# ==========================================
# 5. Âü∑Ë°å TM1 Query
# ==========================================
print("--- 3. Executing TM1 Query ---")
df_tm1 = pd.DataFrame()

try:
    with TM1Service(**TM1_CONFIG) as tm1:
        # Âü∑Ë°å Query
        df_tm1 = tm1.cells.execute_mdx_dataframe(mdx_query)
       ¬†
        # Reset Index (Êää Dimensions ËÆäÊàê Columns)
        df_tm1 = df_tm1.reset_index()
       ¬†
        # üî• ËΩâÁ¥∞Ê•∑ (Á¢∫‰øùË∑ü Excel ‰∏ÄÊ®£)
        df_tm1.columns = df_tm1.columns.str.lower().str.strip()
       ¬†
        print(f"TM1 Returned {len(df_tm1)} rows.")
        # print(df_tm1.head()) # Debug Áî®

except Exception as e:
    print(f"‚ùå TM1 Error: {e}")
    exit()

# ==========================================
# 6. Direct Join (Excel Left Join TM1)
# ==========================================
if not df_tm1.empty:
    print("--- 4. Merging Data ---")
   ¬†
    # 1. ËôïÁêÜ Value Column
    # ‰Ω†ÁöÑÊà™ÂúñÈ°ØÁ§∫ column Âêç‰øÇ 'Value' (Â§ßÂØ´ V)ÔºåËΩâÂ∑¶Á¥∞Ê•∑ÊáâË©≤ËÆä 'value'
    # ÊàëÂú∞Â∞á‰Ω¢ÊîπÂêçÂÅö 'tm1_value' Ë≤ª‰∫ãÊíûÂêç
    val_col = 'value' if 'value' in df_tm1.columns else None
   ¬†
    # Â¶ÇÊûúÊâæ‰∏çÂà∞ valueÔºåË©¶‰∏ãÊâæ 'values' ÊàñËÄÖÂèñÊúÄÂæå‰∏ÄÊ¨Ñ
    if not val_col and 'values' in df_tm1.columns: val_col = 'values'
    if not val_col: val_col = df_tm1.columns[-1]

    print(f"Mapping Value Column: [{val_col}] -> [tm1_value]")
    df_tm1.rename(columns={val_col: 'tm1_value'}, inplace=True)

    # 2. Á¢∫‰øù Keys Ê†ºÂºè‰∏ÄËá¥ (String)
    for col in valid_keys:
        if col in df_tm1.columns:
            df_tm1[col] = df_tm1[col].astype(str)

    # 3. Left Join
    # ‰ΩøÁî® valid_keys (Âç≥‰øÇ Excel Â≠òÂú®ÁöÑÈÇ£‰∫õÁ∂≠Â∫¶ columns) ÂÅö Key
    final_df = pd.merge(
        df_master,
        df_tm1,
        how='left',
        on=valid_keys
    )

    # 4. Â°´Ë£ú 0 (NaN -> 0)
    final_df['tm1_value'] = final_df['tm1_value'].fillna(0)
   ¬†
    # Output
    final_df.to_csv(OUTPUT_FILE, index=False)
    print(f"‚úÖ Success! Saved to: {OUTPUT_FILE}")
    print(final_df[['account', 'measure', 'tm1_value']].head()) # Show sample

else:
    print("‚ö†Ô∏è TM1 returned no data. Filling 0s.")
    df_master['tm1_value'] = 0
    df_master.to_csv(OUTPUT_FILE, index=False)

