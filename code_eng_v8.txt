import pandas as pd
from TM1py import TM1Service

# --- é€£ç·šè¨­å®š ---
TM1_CONFIG = {
    'address': 'localhost',  # ğŸ”‘ å¡«å› IP
    'port': 12345,           # ğŸ”‘ å¡«å› HTTPPort
    'user': 'admin',
    'password': 'password',
    'ssl': True
}

def main():
    CUBE_NAME = "cb_reporting" # ğŸ”‘ ç¢ºèª Cube Name

    print(f"æ­£åœ¨é€£ç·šä¸¦æŸ¥è©¢ Cube: [{CUBE_NAME}] ...")

    # --- åƒæ•¸è¨­å®š ---
    context_map = {
        'Account':                       'BS174',Â 
        'Operating_Unit':                '83146',Â 
        'Scenario':                      'Adjusted Actual',Â 
        'Measure':                       'Mx_2',Â 
       Â 
        # âœ… ä½¿ç”¨é€™å€‹ä¸æœƒå ±éŒ¯çš„æ ¼å¼
        'Time_Period':                   '2025.01',Â 
       Â 
        # --- å…¶ä»– Context ---
        'Amt_Type':                      'Display',
        'Currency':                      'All Currencies',
        'Currency_Display':              'CAD',
        'Project':                       'Total Leafs',
        'Product':                       'Total Leafs',
        'Channel':                       'Total Leafs',
        'Segment':                       'Total Leafs',
        'GAAP':                          'CBTOTAL',
        'Counter_Party_Operating_Unit':  'Total Leafs',
    }

    try:
        if 'Measure' in context_map:
            measure_elem = context_map.pop('Measure')
        else:
            measure_elem = 'Mx_2'

        # çµ„åˆ Rows
        row_mdx_parts = []
        for dim, elem in context_map.items():
            row_mdx_parts.append(f"[{dim}].[{elem}]")
       Â 
        row_mdx_str = " * ".join([f"{{{p}}}" for p in row_mdx_parts])
       Â 
        # ğŸ”¥ é‡é»ä¿®æ”¹ï¼šç§»é™¤äº† 'NON EMPTY'
        # é€™æ¨£å°±ç®—æ•¸å€¼æ˜¯ 0 æˆ– nullï¼Œå®ƒä¹Ÿæœƒå›å‚³çµæœ
        mdx_query = f"""
        SELECT
            {{[Measure].[{measure_elem}]}} ON COLUMNS,
            ( {row_mdx_str} ) ON ROWS
        FROM [{CUBE_NAME}]
        """

        with TM1Service(**TM1_CONFIG) as tm1:
            print("æ­£åœ¨åŸ·è¡Œ Query (å·²ç§»é™¤ NON EMPTY)...")
            df = tm1.cells.execute_mdx_dataframe(mdx_query)
           Â 
            if not df.empty:
                print("\nâœ… æˆåŠŸï¼åº§æ¨™æ­£ç¢ºï¼æ•¸æ“šå¦‚ä¸‹ï¼š")
                print(df)
                # å¦‚æœé€™è£¡æ˜¯ NaN æˆ– 0ï¼Œä»£è¡¨ä½ çµ‚æ–¼é€£é€šäº†ï¼Œåªæ˜¯é‚£æ ¼å‰›å¥½æ²’æ•¸
            else:
                print("\nâŒ ä»ç„¶æ˜¯ç©ºçµæœã€‚é€™éå¸¸ç½•è¦‹ã€‚")
                print("é€™é€šå¸¸ä»£è¡¨ CrossJoin çš„å…¶ä¸­ä¸€å€‹ç¶­åº¦ (ä¸ä¸€å®šæ˜¯ Time) å³ä½¿å­˜åœ¨ï¼Œä½†ä¸åœ¨é€™å€‹ Cube çš„æœ‰æ•ˆç¯„åœå…§ã€‚")

    except Exception as e:
        print(f"\nâŒ éŒ¯èª¤: {e}")

if __name__ == "__main__":
    main()
