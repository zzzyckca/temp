import pandas as pd
from TM1py import TM1Service

# --- 1. é€£ç·šè¨­å®š ---
TM1_CONFIG = {
    'address': 'localhost',  # ğŸ”‘ å¡«ç•ªä½ æ—¢ IP
    'port': 12345,           # ğŸ”‘ å¡«ç•ªä½ æ—¢ HTTPPort
    'user': 'admin',
    'password': 'password',
    'ssl': True
}

def main():
    # ğŸ”‘ Cube Name ä¿‚æœ€å±éšªæ—¢ä½ã€‚
    # Excel é¡¯ç¤º Package ä¿‚ 'cb_reporting'ï¼Œé€šå¸¸ Cube ååŒ Package åç›¸ä¼¼
    # å¦‚æœ run å””åˆ°è©± "Cube not found"ï¼Œè«‹è©¦ä¸‹ 'General Ledger' æˆ–è€…å• admin æ”çœŸå
    CUBE_NAME = "cb_reporting" 

    print(f"æ­£åœ¨é€£ç·šä¸¦æŸ¥è©¢ Cube: [{CUBE_NAME}] ...")

    # --- 2. åƒæ•¸è¨­å®š (æ ¹æ“šä½ å…¨éƒ¨æˆªåœ–æ•´åˆ) ---
    context_map = {
        # --- å·¦é‚Š (TM1 Dimension Name) : å³é‚Š (Element Principal Name) ---
        
        # 1. Account (å·²ç¢ºèªçœŸå)
        'Account':                       'BS174', 
        
        # 2. Operating Unit (æˆªåœ–è¦‹åˆ° 83146-TOTAL...)
        'Operating_Unit':                '83146', 
        
        # 3. Scenario (æˆªåœ– Image 4 é¡¯ç¤ºä¿‚ Adjusted Actual)
        'Scenario':                      'Adjusted Actual', 
        
        # 4. Measure (æˆªåœ– Image 2 é¡¯ç¤ºä¿‚ Mx_2)
        'Measure':                       'Mx_2', 
        
        # 5. Time Period (âš ï¸ é€™æ˜¯å”¯ä¸€ä½ éœ€è¦æ‰‹å‹•å¡«çš„ï¼Œä¸èƒ½å¡« Selection)
        # è«‹å¡«å…¥ä¸€å€‹å­˜åœ¨çš„æœˆä»½æˆ–å¹´ä»½ï¼Œä¾‹å¦‚ '2024', '2023', 'Dec-2023'
        'Time_Period':                   '2024',  # <--- è«‹ä¿®æ”¹é€™è£¡
        
        # --- å…¶ä»–å›ºå®šåƒæ•¸ (æ ¹æ“š Image 2 ç°è‰² Context) ---
        'Amt_Type':                      'Display',
        'Currency':                      'All Currencies',
        'Currency_Display':              'CAD',
        'Project':                       'Total Leafs',
        'Product':                       'Total Leafs',
        'Channel':                       'Total Leafs',
        'Segment':                       'Total Leafs',
        'GAAP':                          'CBTOTAL',
        'Counter_Party_Operating_Unit':  'Total Leafs',
        
        # ç¢ºä¿ Excel VBA è£¡çš„ dimension éƒ½æœ‰åŒ…å…¥ä¾† (è‹¥æœ‰éºæ¼æœƒç”¨åˆ° Default Member)
        # æ ¹æ“š VBA æˆªåœ–ï¼Œæ‡‰è©²é‚„æœ‰ BookedCurrency ?
        # å¦‚æœå ±éŒ¯ Dimension Not Foundï¼Œè«‹æª¢æŸ¥æ‹¼å­—
    }

    # --- 3. è‡ªå‹•çµ„è£ MDX ---
    try:
        # åˆ†é›¢ Measure (æ”¾åœ¨ Column)
        if 'Measure' in context_map:
            measure_elem = context_map.pop('Measure')
        else:
            # å¦‚æœ Measure ç¶­åº¦å””å« 'Measure'ï¼Œå¯èƒ½è¦æ‰‹å‹•æ”¹
            measure_elem = 'Mx_2' 

        # çµ„åˆ Rows
        row_mdx_parts = []
        for dim, elem in context_map.items():
            row_mdx_parts.append(f"[{dim}].[{elem}]")
        
        # ä½¿ç”¨ CrossJoin (*) é€£çµæ‰€æœ‰ç¶­åº¦
        row_mdx_str = " * ".join([f"{{{p}}}" for p in row_mdx_parts])
        
        mdx_query = f"""
        SELECT
            {{[Measure].[{measure_elem}]}} ON COLUMNS,
            NON EMPTY
            ( {row_mdx_str} ) ON ROWS
        FROM [{CUBE_NAME}]
        """

        # print("DEBUG MDX:", mdx_query) # æƒ³ç‡ MDX å¯ä»¥æ‰“é–‹å‘¢è¡Œ

        # --- 4. åŸ·è¡ŒæŸ¥è©¢ ---
        with TM1Service(**TM1_CONFIG) as tm1:
            print("é€£ç·šæˆåŠŸï¼Œæ­£åœ¨åŸ·è¡Œ Query...")
            
            # åŸ·è¡Œ
            df = tm1.cells.execute_mdx_dataframe(mdx_query)
            
            if not df.empty:
                print("\nâœ… æˆåŠŸï¼æ•¸æ“šå¦‚ä¸‹ï¼š")
                print(df)
            else:
                print("\nâš ï¸ æŸ¥è©¢æˆåŠŸä½†çµæœç‚ºç©º (No Data)ã€‚")
                print(f"è«‹ç¢ºèª [{context_map['Time_Period']}] å¹´ä»½æ˜¯å¦æœ‰æ•¸æ“šï¼Œæˆ–è€… [Scenario] æ˜¯å¦æ­£ç¢ºã€‚")

    except Exception as e:
        print(f"\nâŒ éŒ¯èª¤: {e}")
        print("æç¤ºï¼š")
        print("1. å¦‚æœæ˜¯ 'Dimension not found' -> è«‹æª¢æŸ¥ context_map å·¦é‚Šçš„åå­—æ˜¯å¦åŒ Server ä¸€æ¨£ã€‚")
        print("2. å¦‚æœæ˜¯ 'Cube not found' -> è«‹æª¢æŸ¥ CUBE_NAMEã€‚")
        print("3. å¦‚æœæ˜¯ 'Syntax error' -> æª¢æŸ¥æœ‰æ²’æœ‰ç‰¹æ®Šç¬¦è™Ÿã€‚")

if __name__ == "__main__":
    main()