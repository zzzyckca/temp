import pandas as pd
from TM1py import TM1Service

# --- 1. 設定區域 ---
EXCEL_FILE = 'parameters.xlsx'
OUTPUT_FILE = 'final_report.csv'

# 請根據實際情況修改這裡的 Column Mapping
# Excel Column Name : TM1 Dimension Name
COL_MAPPING = {
    'Year': 'Year',
    'Region': 'Region',
    'Department': 'Department'
}

TM1_CONFIG = {
    'address': 'localhost',
    'port': 12345,
    'user': 'admin',
    'password': 'password',
    'ssl': True
}

def format_mdx_set(dim_name, item_list):
    """將 list 轉為 MDX set 字串，例如 {[Dim].[A], [Dim].[B]}"""
    # 轉字串並去空白
    valid_items = [str(x) for x in item_list if pd.notna(x)]
    # 加入 TM1 語法
    formatted = [f"[{dim_name}].[{item}]" for item in valid_items]
    return "{" + ",".join(formatted) + "}"

def main():
    # --- 2. 讀取 Excel 並處理格式 ---
    print("讀取 Excel...")
    df_input = pd.read_excel(EXCEL_FILE)

    # 重要：將 Excel 所有 Key Columns 強制轉為 String
    # 因為 TM1 回傳的 Dimension 元素永遠是 String，不轉型的話 merge 會失敗
    for col in COL_MAPPING.keys():
        df_input[col] = df_input[col].astype(str)

    # --- 3. 準備 MDX Sets ---
    # 提取 Unique values
    years = df_input['Year'].unique().tolist()
    regions = df_input['Region'].unique().tolist()
    depts = df_input['Department'].unique().tolist()

    str_years = format_mdx_set(COL_MAPPING['Year'], years)
    str_regions = format_mdx_set(COL_MAPPING['Region'], regions)
    str_depts = format_mdx_set(COL_MAPPING['Department'], depts)

    # --- 4. 組裝 Bulk MDX Query ---
    # 這裡我們把所有維度放在 ROWS，只留 Measure 在 COLUMNS，方便轉 DataFrame
    mdx = f"""
    SELECT
        {{[Measure].[Amount]}} ON COLUMNS,
        NON EMPTY (
            {str_years} * {str_regions} * {str_depts}
        ) ON ROWS
    FROM [General Ledger]
    """

    print("連接 TM1 並執行查詢...")
    
    df_tm1 = pd.DataFrame() # 初始化

    try:
        with TM1Service(**TM1_CONFIG) as tm1:
            # 執行 MDX
            df_tm1 = tm1.cells.execute_mdx_dataframe(mdx)
            
            # --- 5. 清理 TM1 回傳的 DataFrame ---
            # execute_mdx_dataframe 回傳的 Index 通常是 Dimension Name
            # 我們需要 Reset Index 把維度變回普通 Columns
            df_tm1 = df_tm1.reset_index()
            
            # TM1py 回傳的欄位名稱通常對應 Dimension Name (e.g., "Year", "Region")
            # 這裡我們不需要改名，除非 TM1 Dimension 名稱跟 Excel Header 不一樣
            
            print(f"TM1 回傳了 {len(df_tm1)} 筆廣泛數據 (Cartesian Product)。")

    except Exception as e:
        print(f"TM1 連線或查詢錯誤: {e}")
        return

    # --- 6. 核心步驟：Pandas Merge (Filter) ---
    if not df_tm1.empty:
        print("正在進行數據合併 (Mapping)...")

        # 使用 Left Join: 以 Excel (df_input) 為主，把 TM1 數據 (df_tm1) 貼上去
        # 這樣會自動過濾掉那些「Excel 沒要求，但 MDX 順便抓回來」的多餘組合
        
        final_df = pd.merge(
            df_input, 
            df_tm1, 
            how='left', 
            # 指定對應關係：Left(Excel) vs Right(TM1)
            left_on=['Year', 'Region', 'Department'],
            right_on=['Year', 'Region', 'Department'] # 假設 TM1 Dimension 名稱一致
        )

        # 處理找不到數據的情況 (Fill NA with 0)
        # 假設數據欄位叫 'Amount' (或是 TM1py 回傳的具體 Measure 名稱)
        # 注意: TM1py 回傳的 Value 欄位名稱通常取決於 MDX SELECT COLUMNS 的內容
        value_col = 'Amount' 
        if value_col in final_df.columns:
            final_df[value_col] = final_df[value_col].fillna(0)

        # 輸出
        final_df.to_csv(OUTPUT_FILE, index=False)
        print(f"處理完成！結果已儲存至 {OUTPUT_FILE} (共 {len(final_df)} 行)")
        
    else:
        print("TM1 沒有回傳任何數據，請檢查 Cube 或 MDX。")

if __name__ == "__main__":
    main()