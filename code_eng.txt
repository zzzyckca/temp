import win32com.client
import pythoncom
import os
import shutil
import pandas as pd
from prefect import flow, task
from datetime import datetime

# --- Configuration ---
CONFIG_FILE_PATH = r"C:\Work\config.xlsx"  # Path to your Excel rule file
TEMP_FOLDER = r"C:\Work\Temp"              # Temporary folder for downloading attachments
DEFAULT_FOLDER = r"C:\Work\Unsorted"       # Fallback folder if no rules match
TARGET_SUBJECT = "TRIGGER_ME"              # Email subject keyword to listen for

# Ensure necessary directories exist
for f in [TEMP_FOLDER, DEFAULT_FOLDER]:
    os.makedirs(f, exist_ok=True)

@task(name="Load Config")
def load_config_rules():
    """
    Reads the Excel configuration file and returns a list of rules.
    Expected Excel columns: 'Keyword', 'Destination_Folder'
    """
    try:
        df = pd.read_excel(CONFIG_FILE_PATH)
        # Convert to dictionary for easier lookup. Example: [{'Keyword': 'Invoice', 'Destination_Folder': 'C:\\...'}]
        rules = df.to_dict('records') 
        print(f"üìã Loaded {len(rules)} rules from Excel.")
        return rules
    except Exception as e:
        print(f"‚ùå Error reading config excel: {e}")
        return []

@task(name="Process Attachments")
def save_and_route_attachments(message_item, rules):
    """
    Downloads attachments from the email, checks against Excel rules, 
    and moves them to the specific destination folder.
    """
    # Note: If running in a multi-threaded environment, passing COM objects (message_item) 
    # directly to a task can be risky. For this example, we assume single-thread or flow-level execution.
    
    # Check if attachments exist
    if message_item.Attachments.Count == 0:
        print("No attachments found.")
        return

    # Loop through all attachments
    # Note: Outlook indices start at 1, not 0
    for i in range(1, message_item.Attachments.Count + 1):
        attachment = message_item.Attachments.Item(i)
        filename = attachment.FileName
        print(f"üìé Processing file: {filename}")

        # 1. Save attachment to Temp Folder first
        # win32com requires an absolute path for saving files
        temp_path = os.path.join(TEMP_FOLDER, filename)
        attachment.SaveAsFile(temp_path)

        # 2. Check against Excel Rules
        # Default destination if no rule matches
        destination = DEFAULT_FOLDER
        matched_rule = False

        for rule in rules:
            keyword = str(rule.get('Keyword', '')).lower()
            target_dir = rule.get('Destination_Folder')
            
            # Core Logic: Check if the keyword exists in the filename (case-insensitive)
            if keyword in filename.lower():
                destination = target_dir
                matched_rule = True
                print(f"‚úÖ Matched Rule: '{keyword}' -> {destination}")
                break # Stop checking other rules once a match is found
        
        # 3. Move file to the final destination
        try:
            # Ensure the destination folder exists
            os.makedirs(destination, exist_ok=True)
            
            final_path = os.path.join(destination, filename)
            
            # Move the file. Note: This will overwrite if file exists, or fail depending on permissions.
            # Consider adding timestamp logic here if unique filenames are required.
            shutil.move(temp_path, final_path)
            print(f"üöö Moved to: {final_path}")
            
        except Exception as e:
            print(f"‚ùå Error moving file: {e}")


@flow(name="Excel_Router_Flow", log_prints=True)
def email_router_flow():
    """
    Main orchestration flow:
    1. Initialize COM
    2. Connect to Outlook
    3. Load Rules
    4. Process Emails
    5. Clean up
    """
    # CRITICAL: Initialize COM library for thread safety in Prefect
    pythoncom.CoInitialize() 
    
    try:
        # 1. Connect to Outlook MAPI namespace
        outlook = win32com.client.Dispatch("Outlook.Application").GetNamespace("MAPI")
        inbox = outlook.GetDefaultFolder(6) # Folder ID 6 = Inbox
        
        # 2. Load latest rules from Excel
        rules = load_config_rules()
        
        # 3. Find target emails using Outlook Restrict filter (faster than iterating all items)
        messages = inbox.Items.Restrict(f"[UnRead] = True AND [Subject] = '{TARGET_SUBJECT}'")
        
        # 4. Process each email
        # Convert to list to avoid index shifting issues when modifying items (e.g., moving them)
        for msg in list(messages):
            print(f"üìß New Email Found: {msg.Subject}")
            
            # Route attachments based on logic
            save_and_route_attachments(msg, rules)
            
            # 5. Cleanup: Mark as read
            msg.UnRead = False
            
            # Optional: Move the email to a "Processed" folder in Outlook to prevent re-processing
            # processed_folder = inbox.Folders("Processed")
            # msg.Move(processed_folder)
            
    except Exception as e:
        print(f"Flow Execution Error: {e}")
    finally:
        # Release COM resources
        pythoncom.CoUninitialize()

if __name__ == "__main__":
    # Serve the flow to run indefinitely on a schedule (every 60 seconds)
    print("üöÄ Starting Outlook File Router...")
    email_router_flow.serve(name="file-router-v1", interval=60)