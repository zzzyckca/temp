import imaplib
import win32security
import base64

# --- è¨­å®š ---
IMAP_SERVER = 'imap.fg.rbc.com'
IMAP_PORT = 993

def imap_ntlm_auth(server_host, port):
    try:
        print(f"æ­£åœ¨é€£ç·šåˆ° {server_host}...")
        imap = imaplib.IMAP4_SSL(server_host, port)
        print("é€£ç·šæˆåŠŸã€‚")

        # ã€ä¿®æ­£ 1ã€‘åƒæ•¸æ”¹ç‚º 7 å€‹ï¼Œä¸¦ç›´æ¥å–å¾— handle (ä¸éœ€è¦ [0])
        creds = win32security.AcquireCredentialsHandle(
            None, "NTLM", win32security.SECPKG_CRED_OUTBOUND, 
            None, None, None, None
        )
        
        # å»ºç«‹ä¸€å€‹è®Šæ•¸ä¾†å­˜å„² Context (ç¬¬ä¸€æ¬¡æ˜¯ None)
        ctx = None

        def ntlm_handler(response):
            nonlocal ctx # è®“é€™å€‹å‡½æ•¸å¯ä»¥ä¿®æ”¹å¤–é¢çš„ ctx è®Šæ•¸
            
            # response æ˜¯ Server å‚³ä¾†çš„ Challenge (bytes)
            # å¦‚æœ response æ˜¯ç©ºçš„ï¼Œä»£è¡¨æ˜¯ç¬¬ä¸€æ­¥ (Type 1 Message)
            
            # è¨­å®šè¼¸å…¥ç·©è¡å€ (Input Buffer)
            if not response:
                in_buf = None
            else:
                in_buf = win32security.PySecBufferType(
                    win32security.SECBUFFER_TOKEN, response
                )

            # ã€ä¿®æ­£ 2ã€‘æ”¹ç”¨ win32security.InitializeSecurityContext(...)
            # åƒæ•¸é †åºï¼šæ†‘è­‰, ç¾æœ‰Context, TargetName, Requirements, DataRep, InputBuffer
            err, new_ctx, out_buf = win32security.InitializeSecurityContext(
                creds, ctx, None, 
                win32security.ISC_REQ_CONFIDENTIALITY, 
                win32security.SECURITY_NATIVE_DREP, 
                in_buf
            )
            
            # æ›´æ–° Context ä»¥ä¾¿ä¸‹ä¸€æ­¥ä½¿ç”¨
            ctx = new_ctx
            
            # out_buf æ˜¯ä¸€å€‹ listï¼Œæˆ‘å€‘è¦æ‹¿å‡ºè£¡é¢çš„ Buffer (bytes) å›å‚³çµ¦ Server
            return out_buf[0].Buffer

        print("æ­£åœ¨å˜—è©¦ NTLM é©—è­‰ (ä½¿ç”¨ Windows æ†‘è­‰)...")
        
        # é–‹å§‹é©—è­‰
        result = imap.authenticate('NTLM', ntlm_handler)
        
        print(f"âœ… é©—è­‰çµæœ: {result}")
        print("ğŸ‰ æˆåŠŸç™»å…¥ï¼")
        
        # æª¢æŸ¥ä¸€ä¸‹é è¨­é€²äº†å“ªå€‹ä¿¡ç®±
        imap.select('INBOX')
        status, folders = imap.list()
        print(f"ğŸ“‚ ä¿¡ç®±è³‡æ–™å¤¾åˆ—è¡¨ ({len(folders)} å€‹):")
        for folder in folders[:5]: # åªå°å‰ 5 å€‹é¿å…æ´—ç‰ˆ
            print(folder.decode())
        
        imap.logout()
        return True

    except Exception as e:
        print(f"âŒ ç™¼ç”ŸéŒ¯èª¤: {e}")
        # å°å‡ºè©³ç´°éŒ¯èª¤ä»¥ä¾¿é™¤éŒ¯
        import traceback
        traceback.print_exc()
        return False

if __name__ == "__main__":
    imap_ntlm_auth(IMAP_SERVER, IMAP_PORT)