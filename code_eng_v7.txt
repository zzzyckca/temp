import imaplib
import win32security
import base64

# --- è¨­å®š ---
IMAP_SERVER = 'imap.fg.rbc.com'
IMAP_PORT = 993

# ã€ä¿®æ­£é—œéµã€‘æ‰‹å‹•å®šç¾©é€™äº›å¯èƒ½æœƒç¼ºå¤±çš„å¸¸æ•¸ (Hex å€¼)
# é€™æ¨£å°±ä¸æ€• pywin32 ç‰ˆæœ¬ä¸åŒæ‰¾ä¸åˆ° attribute äº†
ISC_REQ_CONFIDENTIALITY = 0x00000010
SECURITY_NATIVE_DREP = 0x00000010

def imap_ntlm_auth(server_host, port):
    try:
        print(f"æ­£åœ¨é€£ç·šåˆ° {server_host}...")
        imap = imaplib.IMAP4_SSL(server_host, port)
        print("é€£ç·šæˆåŠŸã€‚")

        # 1. å–å¾— NTLM æ†‘è­‰ (Handle)
        # é€™è£¡ç”¨ 7 å€‹åƒæ•¸
        creds = win32security.AcquireCredentialsHandle(
            None, "NTLM", win32security.SECPKG_CRED_OUTBOUND, 
            None, None, None, None
        )
        
        ctx = None

        def ntlm_handler(response):
            nonlocal ctx
            
            # å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ (response ç‚ºç©º)
            if not response:
                in_buf = None
            else:
                # å»ºç«‹è¼¸å…¥ Buffer
                in_buf = win32security.PySecBufferType(
                    win32security.SECBUFFER_TOKEN, response
                )

            # 2. å‘¼å« InitializeSecurityContext
            # ã€ä¿®æ­£ã€‘é€™è£¡ç›´æ¥ä½¿ç”¨æˆ‘å€‘ä¸Šé¢æ‰‹å‹•å®šç¾©çš„æ•¸å­— (ISC_REQ_CONFIDENTIALITY)
            err, new_ctx, out_buf = win32security.InitializeSecurityContext(
                creds, ctx, None, 
                ISC_REQ_CONFIDENTIALITY,  # æ”¹ç”¨è®Šæ•¸
                SECURITY_NATIVE_DREP,     # æ”¹ç”¨è®Šæ•¸
                in_buf
            )
            
            ctx = new_ctx
            
            # å›å‚³ Token çµ¦ Server
            return out_buf[0].Buffer

        print("æ­£åœ¨å˜—è©¦ NTLM é©—è­‰ (ä½¿ç”¨ Windows æ†‘è­‰)...")
        
        # é–‹å§‹é©—è­‰
        result = imap.authenticate('NTLM', ntlm_handler)
        
        print(f"âœ… é©—è­‰çµæœ: {result}")
        print("ğŸ‰ æˆåŠŸç™»å…¥ï¼")
        
        # æª¢æŸ¥è³‡æ–™å¤¾
        imap.select('INBOX')
        status, folders = imap.list()
        print(f"ğŸ“‚ ä¿¡ç®±è³‡æ–™å¤¾åˆ—è¡¨ ({len(folders)} å€‹):")
        for folder in folders[:5]:
            print(folder.decode())
        
        imap.logout()
        return True

    except Exception as e:
        print(f"âŒ ç™¼ç”ŸéŒ¯èª¤: {e}")
        import traceback
        traceback.print_exc()
        return False

if __name__ == "__main__":
    imap_ntlm_auth(IMAP_SERVER, IMAP_PORT)