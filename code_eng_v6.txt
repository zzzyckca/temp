import sys
import subprocess
import os
import importlib.metadata # Requires Python 3.8+

# 1. Specify absolute Chrome path (non-x86 Program Files as requested)
CHROME_PATH = r"C:\Program Files\Google\Chrome\Application\chrome.exe"

def get_chrome_version(file_path):
    """
    Retrieves the exact FileVersion of the executable using PowerShell.
    """
    if not os.path.exists(file_path):
        print(f"âŒ Error: Chrome not found at: {file_path}")
        sys.exit(1)
        
    cmd = f'(Get-Item "{file_path}").VersionInfo.FileVersion'
    try:
        # Execute PowerShell command to get version string
        result = subprocess.check_output(["powershell", "-c", cmd], text=True)
        return result.strip()
    except subprocess.CalledProcessError as e:
        print(f"âŒ Failed to read Chrome version: {e}")
        sys.exit(1)

def check_and_update_chromedriver():
    # Get local Chrome version (e.g., 121.0.6167.85)
    chrome_ver = get_chrome_version(CHROME_PATH)
    print(f"ğŸ” Local Chrome Version: {chrome_ver}")
    
    # Extract Major.Minor.Build only.
    # We ignore the last 'Patch' number because the driver patch version 
    # might not exactly match the browser's, but the Build version usually ensures compatibility.
    base_ver = ".".join(chrome_ver.split('.')[:3])

    try:
        # Check currently installed chromedriver-py version
        installed_ver = importlib.metadata.version("chromedriver-py")
        print(f"ğŸ“¦ Installed chromedriver-py Version: {installed_ver}")
        
        # If installed version starts with the Base Version, it is compatible.
        if installed_ver.startswith(base_ver):
            print("âœ… Version match. Proceeding...")
            return
    except importlib.metadata.PackageNotFoundError:
        print("âš ï¸ chromedriver-py is not installed.")

    print(f"ğŸ”„ Version mismatch detected. Attempting pip install for: {base_ver}.* ...")

    # Define version constraints for pip.
    # Logic: Install >= Current Build, but < Next Build
    # Example: >= 121.0.6167, < 121.0.6168
    next_build = int(base_ver.split('.')[-1]) + 1
    ver_prefix = ".".join(base_ver.split('.')[:2]) # e.g., 121.0
    upper_bound = f"{ver_prefix}.{next_build}"
    
    pkg_req = f"chromedriver-py>={base_ver},<{upper_bound}"

    try:
        # Run pip install.
        # This will utilize your system's pip.ini configuration for proxy settings.
        subprocess.check_call([sys.executable, "-m", "pip", "install", pkg_req])
        
        print("ğŸ‰ Update successful! The script must be restarted to load the new library.")
        print("=========================================")
        # Exit to force a restart. Python cannot reload the DLL/Binary in the same process.
        sys.exit(0) 
    except subprocess.CalledProcessError:
        print("âŒ Update failed. Please check if the version exists on PyPI or verify pip.ini settings.")
        sys.exit(1)

# --- Main Execution Flow ---

# 1. Run the auto-update check first
check_and_update_chromedriver()

# 2. Imports are placed here to ensure we use the updated package
import chromedriver_py
from selenium import webdriver
from selenium.webdriver.chrome.service import Service

print("ğŸš€ Launching Chrome Driver...")
service = Service(chromedriver_py.binary_path)
driver = webdriver.Chrome(service=service)

# Test connection
driver.get("https://www.google.com")
print("âœ… Browser launched successfully.")
